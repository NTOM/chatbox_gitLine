# èŠ‚ç‚¹å¼å¯¹è¯ç³»ç»Ÿå¼€å‘è§„åˆ’

## 1. é¡¹ç›®ç›®æ ‡

### 1.1 æ ¸å¿ƒç›®æ ‡

æ„å»ºä¸€ä¸ª**èŠ‚ç‚¹å¼å¯¹è¯å¯è§†åŒ–ç³»ç»Ÿ**ï¼Œä¸ç°æœ‰çš„çº¿æ€§å¯¹è¯åˆ—è¡¨å¹¶å­˜ï¼Œç”¨æˆ·å¯é€šè¿‡é¡¶éƒ¨æŒ‰é’®ä¸€é”®åˆ‡æ¢ä¸¤ç§è§†å›¾æ¨¡å¼ã€‚

### 1.2 è®¾è®¡åŸåˆ™

- **æ•°æ®ç»Ÿä¸€**ï¼šèŠ‚ç‚¹è§†å›¾ä¸åˆ—è¡¨è§†å›¾å…±äº«åŒä¸€å¥—æ•°æ®ç»“æ„ï¼ˆ`Session`ï¼‰ï¼Œæ— éœ€æ•°æ®è¿ç§»
- **åŒå‘åŒæ­¥**ï¼šåœ¨ä»»ä¸€è§†å›¾ä¸­çš„æ“ä½œéƒ½èƒ½å®æ—¶åæ˜ åˆ°å¦ä¸€è§†å›¾
- **Git é£æ ¼å¸ƒå±€**ï¼šé‡‡ç”¨å‚ç›´æ–¹å‘çš„åˆ†æ”¯å›¾ï¼Œç±»ä¼¼ Git Graph æˆ– Houdini èŠ‚ç‚¹æ ‘
- **æ¸è¿›å¢å¼º**ï¼šä¸ç ´åç°æœ‰åŠŸèƒ½ï¼Œä½œä¸ºå¢å¼ºåŠŸèƒ½å åŠ 

### 1.3 é¢„æœŸæ•ˆæœ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [åˆ—è¡¨è§†å›¾]  [èŠ‚ç‚¹è§†å›¾]                              ä¼šè¯åç§° â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                    â”‚ System   â”‚                             â”‚
â”‚                    â”‚ Prompt   â”‚                             â”‚
â”‚                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                         â”‚                                   â”‚
â”‚                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                             â”‚
â”‚                    â”‚ User Q1  â”‚                             â”‚
â”‚                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                         â”‚                                   â”‚
â”‚                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                             â”‚
â”‚                    â”‚ AI Ans1  â”‚                             â”‚
â”‚                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                              â”‚
â”‚               â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”                         â”‚
â”‚               â”‚User Q2Aâ”‚ â”‚User Q2Bâ”‚  â† åˆ†æ”¯ç‚¹               â”‚
â”‚               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                         â”‚
â”‚               â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”                         â”‚
â”‚               â”‚AI Ans2Aâ”‚ â”‚AI Ans2Bâ”‚                         â”‚
â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                    â–²                                        â”‚
â”‚                    â””â”€â”€ å½“å‰æ´»è·ƒåˆ†æ”¯é«˜äº®                       â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [è¾“å…¥æ¡†]                                          [å‘é€]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ¶æ„å¯¹æ¯”

### 2.1 ç°æœ‰æ¶æ„

```mermaid
graph TB
    subgraph DataLayer[æ•°æ®å±‚]
        Session[Session ä¼šè¯æ•°æ®]
        Messages[messages: Message]
        Threads[threads: SessionThread]
        Forks[messageForksHash: Record]
    end

    subgraph StoreLayer[çŠ¶æ€ç®¡ç†å±‚]
        ChatStore[chatStore]
        SessionActions[sessionActions]
    end

    subgraph ViewLayer[è§†å›¾å±‚]
        MessageList[MessageList ç»„ä»¶]
        Message[Message ç»„ä»¶]
        ForkNav[ForkNav åˆ†æ”¯å¯¼èˆª]
    end

    Session --> Messages
    Session --> Threads
    Session --> Forks

    ChatStore --> Session
    SessionActions --> ChatStore

    MessageList --> Message
    Message --> ForkNav
    ChatStore --> MessageList
```

### 2.2 æ–°æ¶æ„
![image.png](https://note.youdao.com/yws/res/e/WEBRESOURCEef826c8a9044aeb2c7450437e927f24e)
```mermaid
graph TB
    subgraph DataLayer[æ•°æ®å±‚ - ä¿æŒä¸å˜]
        Session[Session ä¼šè¯æ•°æ®]
        Messages[messages: Message]
        Threads[threads: SessionThread]
        Forks[messageForksHash: Record]
    end

    subgraph StoreLayer[çŠ¶æ€ç®¡ç†å±‚]
        ChatStore[chatStore]
        SessionActions[sessionActions]
        TreeStore[conversationTreeStore<br/>æ–°å¢ï¼šè§†å›¾çŠ¶æ€ç®¡ç†]
    end

    subgraph AdapterLayer[é€‚é…å±‚ - æ–°å¢]
        TreeAdapter[TreeAdapter<br/>Session â†” æ ‘å½¢ç»“æ„è½¬æ¢]
    end

    subgraph ViewLayer[è§†å›¾å±‚]
        ViewSwitch[ViewModeSwitch<br/>è§†å›¾åˆ‡æ¢æŒ‰é’®]
        
        subgraph ListView[åˆ—è¡¨è§†å›¾ - ä¿æŒä¸å˜]
            MessageList[MessageList]
            Message[Message]
        end
        
        subgraph TreeView[èŠ‚ç‚¹è§†å›¾ - æ–°å¢]
            ConversationTree[ConversationTreeView]
            TreeNodes[è‡ªå®šä¹‰èŠ‚ç‚¹ç»„ä»¶]
            TreeEdges[è‡ªå®šä¹‰è¿çº¿ç»„ä»¶]
            TreeControls[æ§åˆ¶é¢æ¿]
        end
    end

    Session --> Messages
    Session --> Threads
    Session --> Forks

    ChatStore --> Session
    SessionActions --> ChatStore
    TreeStore --> TreeAdapter

    TreeAdapter --> Session
    TreeAdapter --> ConversationTree

    ViewSwitch --> ListView
    ViewSwitch --> TreeView

    ChatStore --> MessageList
    ChatStore --> ConversationTree
```

### 2.3 æ•°æ®æµå¯¹æ¯”

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant View as è§†å›¾å±‚
    participant Adapter as é€‚é…å±‚
    participant Store as çŠ¶æ€ç®¡ç†
    participant Data as Sessionæ•°æ®

    rect rgb(200, 230, 200)
        Note over User,Data: åˆ—è¡¨è§†å›¾æ“ä½œæµç¨‹ï¼ˆç°æœ‰ï¼‰
        User->>View: å‘é€æ¶ˆæ¯
        View->>Store: insertMessage()
        Store->>Data: æ›´æ–° messages[]
        Data-->>View: è§¦å‘é‡æ¸²æŸ“
    end

    rect rgb(200, 200, 230)
        Note over User,Data: èŠ‚ç‚¹è§†å›¾æ“ä½œæµç¨‹ï¼ˆæ–°å¢ï¼‰
        User->>View: ä»èŠ‚ç‚¹å‘é€æ¶ˆæ¯
        View->>Adapter: å®šä½å½“å‰èŠ‚ç‚¹è·¯å¾„
        Adapter->>Store: insertMessage() / createNewFork()
        Store->>Data: æ›´æ–° messages[] / messageForksHash
        Data->>Adapter: é‡æ–°æ„å»ºæ ‘ç»“æ„
        Adapter-->>View: æ›´æ–°èŠ‚ç‚¹å’Œè¿çº¿
    end
```

---

## 3. æŠ€æœ¯æ ˆæ¦‚è§ˆ

### 3.1 ç°æœ‰æŠ€æœ¯æ ˆï¼ˆä¿æŒï¼‰

| ç±»åˆ« | æŠ€æœ¯ | ç”¨é€” |
|------|------|------|
| æ¡†æ¶ | React 18 | UI æ¡†æ¶ |
| çŠ¶æ€ç®¡ç† | Zustand + Jotai | å…¨å±€çŠ¶æ€ |
| æ•°æ®æŸ¥è¯¢ | TanStack Query | ç¼“å­˜ä¸åŒæ­¥ |
| UI ç»„ä»¶ | Mantine | åŸºç¡€ç»„ä»¶åº“ |
| æ ·å¼ | Tailwind CSS | åŸå­åŒ–æ ·å¼ |
| ç±»å‹æ ¡éªŒ | Zod | è¿è¡Œæ—¶ç±»å‹éªŒè¯ |

### 3.2 æ–°å¢æŠ€æœ¯æ ˆ

| ç±»åˆ« | æŠ€æœ¯ | ç”¨é€” | é€‰æ‹©ç†ç”± |
|------|------|------|----------|
| èŠ‚ç‚¹ç¼–è¾‘å™¨ | **ReactFlow** | èŠ‚ç‚¹å›¾æ¸²æŸ“ä¸äº¤äº’ | æˆç†Ÿç¨³å®šã€æ–‡æ¡£å®Œå–„ã€æ”¯æŒè‡ªå®šä¹‰èŠ‚ç‚¹ |
| å¸ƒå±€ç®—æ³• | **dagre** | è‡ªåŠ¨è®¡ç®—èŠ‚ç‚¹ä½ç½® | è½»é‡ã€æ”¯æŒå‚ç›´å¸ƒå±€ã€ä¸ ReactFlow é›†æˆè‰¯å¥½ |
| åŠ¨ç”» | **Framer Motion** | èŠ‚ç‚¹åŠ¨ç”»æ•ˆæœ | é¡¹ç›®å¯èƒ½å·²æœ‰ï¼Œæˆ–ä½¿ç”¨ Mantine å†…ç½®åŠ¨ç”» |

### 3.3 æŠ€æœ¯æ¶æ„å›¾
![image.png](https://note.youdao.com/yws/res/f/WEBRESOURCEe9677ea8c52d559e670b9d44a153207f)
```mermaid
graph LR
    subgraph Frontend[å‰ç«¯æŠ€æœ¯æ ˆ]
        React[React 18]
        
        subgraph State[çŠ¶æ€ç®¡ç†]
            Zustand
            Jotai
            TanStack[TanStack Query]
        end
        
        subgraph UI[UIå±‚]
            Mantine
            Tailwind
            ReactFlow[ReactFlow<br/>æ–°å¢]
        end
        
        subgraph Utils[å·¥å…·å±‚]
            Zod
            Dagre[Dagre<br/>æ–°å¢]
        end
    end

    React --> State
    React --> UI
    State --> Utils
```

---

## 4. é˜¶æ®µè®¡åˆ’

### é˜¶æ®µæ€»è§ˆ

```mermaid
gantt
    title èŠ‚ç‚¹å¼å¯¹è¯ç³»ç»Ÿå¼€å‘è·¯çº¿å›¾
    dateFormat  YYYY-MM-DD
    section é˜¶æ®µä¸€
    åŸºç¡€è®¾æ–½æ­å»º           :a1, 2024-01-01, 7d
    section é˜¶æ®µäºŒ
    æ ¸å¿ƒè§†å›¾å®ç°           :a2, after a1, 10d
    section é˜¶æ®µä¸‰
    äº¤äº’åŠŸèƒ½å®Œå–„           :a3, after a2, 10d
    section é˜¶æ®µå››
    ä½“éªŒä¼˜åŒ–ä¸æµ‹è¯•         :a4, after a3, 7d
```

---

### é˜¶æ®µä¸€ï¼šåŸºç¡€è®¾æ–½æ­å»º 

âœ… å·²å®Œæˆ

#### ç›®æ ‡
å»ºç«‹èŠ‚ç‚¹è§†å›¾çš„æŠ€æœ¯åŸºç¡€ï¼Œå®ç°æ•°æ®é€‚é…å±‚ï¼Œå®Œæˆè§†å›¾åˆ‡æ¢æ¡†æ¶ã€‚

#### é¢„æœŸæ•ˆæœ
- âœ… é¡¶éƒ¨å‡ºç°è§†å›¾åˆ‡æ¢æŒ‰é’®
- âœ… ç‚¹å‡»"èŠ‚ç‚¹è§†å›¾"å¯åˆ‡æ¢åˆ° ReactFlow ç”»å¸ƒ
- âœ… æ§åˆ¶å°å¯æ‰“å°å‡ºè½¬æ¢åçš„æ ‘å½¢æ•°æ®ç»“æ„
- âœ… åŸºç¡€èŠ‚ç‚¹æ¸²æŸ“ï¼ˆSystem/User/Assistant ä¸‰ç§ç±»å‹ï¼‰

#### æ¶‰åŠæŠ€æœ¯
- âœ… ReactFlow (@xyflow/react) å®‰è£…ä¸åŸºç¡€é…ç½®
- âœ… dagre å¸ƒå±€ç®—æ³•é›†æˆ
- âœ… Session â†’ ConversationTree æ•°æ®è½¬æ¢å™¨
- âœ… è§†å›¾åˆ‡æ¢çŠ¶æ€ç®¡ç†

#### å·²åˆ›å»ºæ–‡ä»¶
```
src/renderer/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ conversation-tree/
â”‚       â”œâ”€â”€ index.ts                        # ç»„ä»¶å¯¼å‡º
â”‚       â”œâ”€â”€ ConversationTreeView.tsx        # ä¸»è§†å›¾ç»„ä»¶
â”‚       â”œâ”€â”€ ViewModeSwitch.tsx              # è§†å›¾åˆ‡æ¢æŒ‰é’®
â”‚       â””â”€â”€ nodes/
â”‚           â”œâ”€â”€ index.ts                    # èŠ‚ç‚¹å¯¼å‡º
â”‚           â”œâ”€â”€ SystemNode.tsx              # ç³»ç»Ÿæç¤ºèŠ‚ç‚¹
â”‚           â”œâ”€â”€ UserNode.tsx                # ç”¨æˆ·æ¶ˆæ¯èŠ‚ç‚¹
â”‚           â””â”€â”€ AssistantNode.tsx           # AIå›å¤èŠ‚ç‚¹
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ conversation-tree-adapter.ts        # Session â†’ Tree æ•°æ®è½¬æ¢
â”‚   â””â”€â”€ tree-layout.ts                      # dagre å¸ƒå±€ç®—æ³•å°è£…
â””â”€â”€ stores/
    â””â”€â”€ viewModeStore.ts                    # è§†å›¾æ¨¡å¼çŠ¶æ€ç®¡ç†

ä¿®æ”¹çš„æ–‡ä»¶:
- src/renderer/components/Header.tsx        # æ·»åŠ è§†å›¾åˆ‡æ¢æŒ‰é’®
- src/renderer/routes/session/$sessionId.tsx # æ ¹æ®è§†å›¾æ¨¡å¼åˆ‡æ¢æ˜¾ç¤º
- src/renderer/i18n/locales/en/translation.json  # è‹±æ–‡ç¿»è¯‘
- src/renderer/i18n/locales/zh-Hans/translation.json # ä¸­æ–‡ç¿»è¯‘
```

#### æ ¸å¿ƒæ•°æ®ç»“æ„
```typescript
// æ ‘èŠ‚ç‚¹å®šä¹‰
interface TreeNode {
  id: string
  type: 'system' | 'user' | 'assistant'
  message: Message
  parentId: string | null
  childrenIds: string[]
  branchIndex?: number        // åœ¨åŒçº§åˆ†æ”¯ä¸­çš„ç´¢å¼•
  isActivePath: boolean       // æ˜¯å¦åœ¨å½“å‰æ´»è·ƒè·¯å¾„ä¸Š
}

// æ ‘ç»“æ„
interface ConversationTree {
  nodes: Map<string, TreeNode>
  edges: Array<{ source: string; target: string }>
  rootId: string
  activeLeafId: string        // å½“å‰æ´»è·ƒåˆ†æ”¯çš„å¶å­èŠ‚ç‚¹
}
```

---

### é˜¶æ®µäºŒï¼šæ ¸å¿ƒè§†å›¾å®ç°

âœ… å·²å®Œæˆ

#### ç›®æ ‡
å®ç°å®Œæ•´çš„èŠ‚ç‚¹æ ‘å¯è§†åŒ–ï¼ŒåŒ…æ‹¬è‡ªå®šä¹‰èŠ‚ç‚¹æ ·å¼ã€è¿çº¿æ ·å¼å’Œè‡ªåŠ¨å¸ƒå±€ã€‚

#### é¢„æœŸæ•ˆæœ
- âœ… å¯¹è¯ä»¥å‚ç›´æ ‘å½¢ç»“æ„å±•ç¤º
- âœ… ä¸åŒè§’è‰²çš„æ¶ˆæ¯æœ‰ä¸åŒçš„èŠ‚ç‚¹æ ·å¼
- âœ… åˆ†æ”¯ç‚¹æ¸…æ™°å¯è§ï¼Œåˆ†æ”¯ç”¨ä¸åŒé¢œè‰²åŒºåˆ†
- âœ… å½“å‰æ´»è·ƒåˆ†æ”¯é«˜äº®æ˜¾ç¤º
- âœ… æ”¯æŒç”»å¸ƒç¼©æ”¾ã€æ‹–æ‹½ã€å°åœ°å›¾

#### æ¶‰åŠæŠ€æœ¯
- âœ… ReactFlow è‡ªå®šä¹‰èŠ‚ç‚¹ï¼ˆCustom Nodesï¼‰
- âœ… ReactFlow è‡ªå®šä¹‰è¾¹ï¼ˆCustom Edgesï¼‰
- âœ… dagre å‚ç›´å¸ƒå±€é…ç½®
- âœ… Tailwind èŠ‚ç‚¹æ ·å¼

#### å·²åˆ›å»º/ä¿®æ”¹æ–‡ä»¶
```
src/renderer/components/conversation-tree/
â”œâ”€â”€ edges/                          # è‡ªå®šä¹‰è¾¹ç»„ä»¶ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ index.ts                    # è¾¹ç»„ä»¶å¯¼å‡º
â”‚   â”œâ”€â”€ ActivePathEdge.tsx          # æ´»è·ƒè·¯å¾„è¾¹ï¼ˆç»¿è‰²å‘å…‰+æµåŠ¨åŠ¨ç”»ï¼‰
â”‚   â”œâ”€â”€ BranchEdge.tsx              # åˆ†æ”¯è¾¹ï¼ˆå½©è‰²è™šçº¿ï¼‰
â”‚   â””â”€â”€ DefaultEdge.tsx             # é»˜è®¤è¾¹ï¼ˆç°è‰²ï¼‰
â”œâ”€â”€ utils/                          # å·¥å…·å‡½æ•°ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ index.ts                    # å·¥å…·å¯¼å‡º
â”‚   â””â”€â”€ branchColors.ts             # åˆ†æ”¯é¢œè‰²ç³»ç»Ÿï¼ˆ8è‰²è°ƒè‰²æ¿ï¼‰
â”œâ”€â”€ nodes/
â”‚   â”œâ”€â”€ UserNode.tsx                # æ›´æ–°ï¼šæ·»åŠ åˆ†æ”¯é¢œè‰²æŒ‡ç¤º
â”‚   â””â”€â”€ AssistantNode.tsx           # æ›´æ–°ï¼šæ·»åŠ åˆ†æ”¯é¢œè‰²+å­åˆ†æ”¯æŒ‡ç¤ºå™¨
â”œâ”€â”€ ConversationTreeView.tsx        # æ›´æ–°ï¼šé›†æˆè‡ªå®šä¹‰è¾¹ç±»å‹
â””â”€â”€ index.ts                        # æ›´æ–°ï¼šå¯¼å‡ºè¾¹ç±»å‹

src/renderer/lib/
â””â”€â”€ conversation-tree-adapter.ts    # æ›´æ–°ï¼šè¾¹æ•°æ®å¢åŠ branchIndex
```

#### èŠ‚ç‚¹ç±»å‹è®¾è®¡
```mermaid
graph TB
    subgraph NodeTypes[èŠ‚ç‚¹ç±»å‹]
        SystemNode[SystemNode<br/>ç³»ç»Ÿæç¤ºèŠ‚ç‚¹<br/>ç°è‰²/è™šçº¿è¾¹æ¡†]
        UserNode[UserNode<br/>ç”¨æˆ·æ¶ˆæ¯èŠ‚ç‚¹<br/>è“è‰²ä¸»é¢˜]
        AssistantNode[AssistantNode<br/>AIå›å¤èŠ‚ç‚¹<br/>ç»¿è‰²ä¸»é¢˜]
        BranchIndicator[BranchIndicator<br/>åˆ†æ”¯æŒ‡ç¤ºå™¨<br/>æ˜¾ç¤ºåˆ†æ”¯æ•°é‡]
    end
```

#### è¿çº¿ç±»å‹è®¾è®¡
```mermaid
graph TB
    subgraph EdgeTypes[è¿çº¿ç±»å‹]
        MainEdge[MainEdge<br/>ä¸»è·¯å¾„è¿çº¿<br/>å®çº¿/è¾ƒç²—]
        BranchEdge[BranchEdge<br/>åˆ†æ”¯è¿çº¿<br/>è™šçº¿/å¸¦é¢œè‰²]
        ActiveEdge[ActiveEdge<br/>æ´»è·ƒè·¯å¾„<br/>é«˜äº®/åŠ¨ç”»]
    end
```

---

### é˜¶æ®µä¸‰ï¼šäº¤äº’åŠŸèƒ½å®Œå–„

ğŸ”„ **è¿›è¡Œä¸­**

#### ç›®æ ‡
å®ç°èŠ‚ç‚¹è§†å›¾ä¸­çš„æ‰€æœ‰äº¤äº’æ“ä½œï¼Œç¡®ä¿ä¸åˆ—è¡¨è§†å›¾åŠŸèƒ½å¯¹ç­‰ã€‚

#### ä»»åŠ¡æ¸…å•

| # | ä»»åŠ¡ | çŠ¶æ€ | ä¾èµ– |
|---|------|------|------|
| 3.1 | æ¶ˆæ¯è¯¦æƒ…æŠ½å±‰ç»„ä»¶ | âœ… å·²å®Œæˆ | - |
| 3.2 | èŠ‚ç‚¹æ‚¬æµ®æ“ä½œæŒ‰é’®æ  | âœ… å·²å®Œæˆ | - |
| 3.3 | æ–‡æœ¬é€‰ä¸­å¼•ç”¨åŠŸèƒ½ | âœ… å·²å®Œæˆ | 3.1 |
| 3.4 | Output Handle åˆ›å»ºé¢æ¿ï¼ˆå°±åœ°è¾“å…¥ï¼‰ | âœ… å·²å®Œæˆ | - |
| 3.5 | åº•éƒ¨è¾“å…¥æ¡†å¢å¼ºï¼ˆç›®æ ‡èŠ‚ç‚¹é€‰æ‹©å™¨ï¼‰ | âœ… å·²å®Œæˆ | 3.4 |
| 3.6 | é›†æˆæµ‹è¯• | â¬œ å¾…å¼€å§‹ | 3.1-3.5 |

#### é¢„æœŸæ•ˆæœ
- âœ… ç‚¹å‡»èŠ‚ç‚¹å¯æŸ¥çœ‹å®Œæ•´æ¶ˆæ¯å†…å®¹ï¼ˆå³ä¾§æŠ½å±‰ï¼‰
- âœ… é¼ æ ‡æ‚¬æµ®èŠ‚ç‚¹æ˜¾ç¤ºåº•éƒ¨æ“ä½œæŒ‰é’®æ 
- âœ… åœ¨æŠ½å±‰ä¸­é€‰ä¸­æ–‡å­—åå¯å¼•ç”¨åˆ°æ–°æ¶ˆæ¯
- âœ… ç‚¹å‡»èŠ‚ç‚¹åº•éƒ¨ Output Handle å¯åˆ›å»ºæ–°èŠ‚ç‚¹
- âœ… åº•éƒ¨è¾“å…¥æ¡†æ”¯æŒæŒ‡å®šç›®æ ‡èŠ‚ç‚¹
- âœ… åˆ—è¡¨è§†å›¾ä¸­çš„æ“ä½œå®æ—¶åŒæ­¥åˆ°èŠ‚ç‚¹è§†å›¾
- âœ… æ ‘å›¾ä¹Ÿæ”¯æŒé€æ¸å‡ºå­—çš„æ•ˆæœ
- âœ… åœ¨ä¸æ˜¯å½“å‰åˆ†æ”¯çš„æƒ…å†µä¸‹ï¼Œé¼ æ ‡æ‚¬æµ®æ—¶å€™è¦å¢åŠ ä¸€ä¸ªæ–°çš„æŒ‰é’®ï¼Œç”¨äºåˆ‡æ¢åˆ°è¯¥åˆ†æ”¯


#### é—®é¢˜
- âœ… éå½“å‰åˆ†æ”¯çš„åˆ‡æ¢åˆ†æ”¯æŒ‰é’®æ— æ•ˆï¼Œæˆ‘è®¤ä¸ºå¿…é¡»æœ‰æ•ˆ
- âœ… æ–°å»ºuserçš„æµ®çª—å‡ºç°åï¼Œè¾“å…¥å‘é€ï¼Œåº”è¯¥è‡ªåŠ¨ä¹Ÿæ¥ç€ç”Ÿæˆä¸€ä¸ªAIèŠ‚ç‚¹è¿›è¡Œå›ç­”æ‰åˆç†
- â¬œ å½“å‰èŠ‚ç‚¹ä¸‹æ–¹çš„é‚£ä¸ªæ‚¬æµ®ç•Œé¢ï¼Œé¼ æ ‡ç§»åŠ¨è¿‡å»çš„æ—¶å€™å› ä¸ºæµ®çª—å’ŒèŠ‚ç‚¹ä¹‹é—´æœ‰ç”»æ¿ç©ºéš™ï¼Œæ‰€ä»¥æµ®çª—å®¹æ˜“æ¶ˆå¤±
- âœ… æ–°å»ºä¸€ä¸ªAI ResponseèŠ‚ç‚¹æœ‰é”™è¯¯ï¼š

#### å·²åˆ›å»ºæ–‡ä»¶
```
src/renderer/components/conversation-tree/
â”œâ”€â”€ MessageDetailDrawer.tsx        # âœ… æ¶ˆæ¯è¯¦æƒ…æŠ½å±‰
â”œâ”€â”€ TextSelectionQuote.tsx         # âœ… æ–‡æœ¬é€‰ä¸­å¼•ç”¨ç»„ä»¶
â”œâ”€â”€ NodeActionBar.tsx              # âœ… èŠ‚ç‚¹æ‚¬æµ®æ“ä½œæŒ‰é’®æ 
â”œâ”€â”€ NodeCreatePopover.tsx          # âœ… Output Handle åˆ›å»ºé¢æ¿
â””â”€â”€ TargetNodeSelector.tsx         # âœ… ç›®æ ‡èŠ‚ç‚¹é€‰æ‹©å™¨
```

#### è¯¦ç»†åŠŸèƒ½è®¾è®¡

##### 3.1 æ¶ˆæ¯è¯¦æƒ…æŠ½å±‰
- **è§¦å‘æ–¹å¼**ï¼šå•å‡»èŠ‚ç‚¹
- **ä½ç½®**ï¼šå³ä¾§æ»‘å‡ºæŠ½å±‰
- **å†…å®¹**ï¼šå®Œæ•´æ¶ˆæ¯å†…å®¹ï¼ˆMarkdown æ¸²æŸ“ï¼‰ã€æ¶ˆæ¯å…ƒä¿¡æ¯ï¼ˆæ—¶é—´ã€Token ç”¨é‡ç­‰ï¼‰
- **ç»„ä»¶**ï¼š`MessageDetailDrawer.tsx`

##### 3.2 èŠ‚ç‚¹æ‚¬æµ®æ“ä½œæŒ‰é’®æ 
- **è§¦å‘æ–¹å¼**ï¼šé¼ æ ‡æ‚¬æµ®èŠ‚ç‚¹
- **ä½ç½®**ï¼šèŠ‚ç‚¹åº•éƒ¨
- **User èŠ‚ç‚¹æŒ‰é’®**ï¼šç¼–è¾‘ã€å¤åˆ¶ã€å¼•ç”¨ã€åˆ é™¤
- **Assistant èŠ‚ç‚¹æŒ‰é’®**ï¼šé‡æ–°ç”Ÿæˆã€å¤åˆ¶ã€å¼•ç”¨ã€åˆ é™¤
- **ç»„ä»¶**ï¼š`NodeActionBar.tsx`

##### 3.3 æ–‡æœ¬é€‰ä¸­å¼•ç”¨åŠŸèƒ½
- **è§¦å‘æ–¹å¼**ï¼šåœ¨æŠ½å±‰ä¸­é€‰ä¸­æ–‡å­—
- **äº¤äº’**ï¼šé€‰ä¸­åå‡ºç°æµ®çª—"å¼•ç”¨"æŒ‰é’®
- **æ•ˆæœ**ï¼šç‚¹å‡»ååœ¨å½“å‰æ´»è·ƒåˆ†æ”¯æœ«å°¾åˆ›å»º User èŠ‚ç‚¹ï¼Œé™„ä¸Šå¼•ç”¨å†…å®¹
- **ç»„ä»¶**ï¼š`TextSelectionQuote.tsx`

##### 3.4 Output Handle åˆ›å»ºé¢æ¿
- **è§¦å‘æ–¹å¼**ï¼šç‚¹å‡»èŠ‚ç‚¹åº•éƒ¨çš„ Output Handleï¼ˆè¿æ¥ç‚¹ï¼‰
- **äº¤äº’**ï¼šå¼¹å‡º Popover åˆ›å»ºé¢æ¿
- **æ”¯æŒåˆ›å»º**ï¼š
  - **User èŠ‚ç‚¹**ï¼šæ˜¾ç¤ºç®€æ˜“è¾“å…¥æ¡†ï¼Œæ”¯æŒå°±åœ°è¾“å…¥
  - **Assistant èŠ‚ç‚¹**ï¼šä»…å½“å‰èŠ‚ç‚¹ä¸º User æ—¶å¯ç”¨ï¼Œç›´æ¥è§¦å‘ AI ç”Ÿæˆ
- **åˆ†æ”¯é€»è¾‘**ï¼š
  - ä»å¶å­èŠ‚ç‚¹åˆ›å»º â†’ å»¶ç»­å½“å‰åˆ†æ”¯
  - ä»ä¸­é—´èŠ‚ç‚¹åˆ›å»º â†’ è‡ªåŠ¨åˆ›å»ºæ–°åˆ†æ”¯
- **ç»„ä»¶**ï¼š`NodeCreatePopover.tsx`

##### 3.5 åº•éƒ¨è¾“å…¥æ¡†å¢å¼º
- **æ–°å¢åŠŸèƒ½**ï¼šç›®æ ‡èŠ‚ç‚¹é€‰æ‹©å™¨
- **äº¤äº’**ï¼šå¯æŒ‡å®šä»å“ªä¸ªèŠ‚ç‚¹ååˆ›å»ºæ–°æ¶ˆæ¯
- **é»˜è®¤è¡Œä¸º**ï¼šå½“å‰æ´»è·ƒåˆ†æ”¯æœ«å°¾
- **ä¸ 3.4 è”åŠ¨**ï¼šä» Output Handle åˆ›å»ºæ—¶å¯é€‰æ‹©ä½¿ç”¨åº•éƒ¨è¾“å…¥æ¡†

#### æ¶‰åŠæŠ€æœ¯
- ReactFlow äº‹ä»¶å¤„ç†ï¼ˆonNodeClick, onNodeContextMenuï¼‰
- Mantine Drawer/Popover/Menu ç»„ä»¶
- ç°æœ‰ sessionActions å¤ç”¨
- æ–‡æœ¬é€‰æ‹© APIï¼ˆSelection APIï¼‰
- åŒå‘æ•°æ®åŒæ­¥æœºåˆ¶

#### è®¡åˆ’åˆ›å»ºæ–‡ä»¶
```
src/renderer/components/conversation-tree/
â”œâ”€â”€ MessageDetailDrawer.tsx        # æ¶ˆæ¯è¯¦æƒ…æŠ½å±‰
â”œâ”€â”€ NodeActionBar.tsx              # èŠ‚ç‚¹æ‚¬æµ®æ“ä½œæŒ‰é’®æ 
â”œâ”€â”€ TextSelectionQuote.tsx         # æ–‡æœ¬é€‰ä¸­å¼•ç”¨ç»„ä»¶
â”œâ”€â”€ NodeCreatePopover.tsx          # Output Handle åˆ›å»ºé¢æ¿
â””â”€â”€ TargetNodeSelector.tsx         # ç›®æ ‡èŠ‚ç‚¹é€‰æ‹©å™¨ï¼ˆåº•éƒ¨è¾“å…¥æ¡†å¢å¼ºï¼‰
```

#### äº¤äº’æµç¨‹
```mermaid
stateDiagram-v2
    [*] --> æµè§ˆæ¨¡å¼
    
    æµè§ˆæ¨¡å¼ --> æŸ¥çœ‹æ¶ˆæ¯: å•å‡»èŠ‚ç‚¹
    æµè§ˆæ¨¡å¼ --> æ“ä½œèœå•: å³é”®èŠ‚ç‚¹
    æµè§ˆæ¨¡å¼ --> åˆ‡æ¢åˆ†æ”¯: ç‚¹å‡»éæ´»è·ƒåˆ†æ”¯
    æµè§ˆæ¨¡å¼ --> åˆ›å»ºèŠ‚ç‚¹: ç‚¹å‡» Output Handle
    
    æŸ¥çœ‹æ¶ˆæ¯ --> æµè§ˆæ¨¡å¼: å…³é—­æŠ½å±‰
    æŸ¥çœ‹æ¶ˆæ¯ --> å¼•ç”¨æ–‡æœ¬: é€‰ä¸­æ–‡å­—ç‚¹å‡»å¼•ç”¨
    
    å¼•ç”¨æ–‡æœ¬ --> æµè§ˆæ¨¡å¼: åˆ›å»ºå¼•ç”¨æ¶ˆæ¯
    
    æ“ä½œèœå• --> é‡æ–°ç”Ÿæˆ: é€‰æ‹©"é‡æ–°ç”Ÿæˆ"
    æ“ä½œèœå• --> åˆ›å»ºåˆ†æ”¯: é€‰æ‹©"ä»è¿™é‡Œåˆ†æ”¯"
    æ“ä½œèœå• --> åˆ é™¤åˆ†æ”¯: é€‰æ‹©"åˆ é™¤æ­¤åˆ†æ”¯"
    æ“ä½œèœå• --> æµè§ˆæ¨¡å¼: å–æ¶ˆ
    
    é‡æ–°ç”Ÿæˆ --> æµè§ˆæ¨¡å¼: ç”Ÿæˆå®Œæˆ
    åˆ›å»ºåˆ†æ”¯ --> è¾“å…¥æ¨¡å¼: åˆ†æ”¯åˆ›å»ºæˆåŠŸ
    åˆ é™¤åˆ†æ”¯ --> æµè§ˆæ¨¡å¼: åˆ é™¤å®Œæˆ
    
    åˆ‡æ¢åˆ†æ”¯ --> æµè§ˆæ¨¡å¼: è·¯å¾„åˆ‡æ¢å®Œæˆ
    
    åˆ›å»ºèŠ‚ç‚¹ --> å°±åœ°è¾“å…¥: é€‰æ‹©åˆ›å»º User èŠ‚ç‚¹
    åˆ›å»ºèŠ‚ç‚¹ --> AIç”Ÿæˆ: é€‰æ‹©åˆ›å»º Assistant èŠ‚ç‚¹
    åˆ›å»ºèŠ‚ç‚¹ --> åº•éƒ¨è¾“å…¥æ¡†: é€‰æ‹©ä½¿ç”¨åº•éƒ¨è¾“å…¥æ¡†
    
    å°±åœ°è¾“å…¥ --> æµè§ˆæ¨¡å¼: å‘é€æ¶ˆæ¯
    AIç”Ÿæˆ --> æµè§ˆæ¨¡å¼: ç”Ÿæˆå®Œæˆ
    åº•éƒ¨è¾“å…¥æ¡† --> æµè§ˆæ¨¡å¼: å‘é€æ¶ˆæ¯
    
    è¾“å…¥æ¨¡å¼ --> æµè§ˆæ¨¡å¼: å‘é€æ¶ˆæ¯
```

---

### é˜¶æ®µå››ï¼šä½“éªŒä¼˜åŒ–ä¸æµ‹è¯•

#### ç›®æ ‡
ä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼Œå¤„ç†è¾¹ç•Œæƒ…å†µï¼Œç¡®ä¿ç¨³å®šæ€§ã€‚

#### é¢„æœŸæ•ˆæœ
- å¤§å‹å¯¹è¯æ ‘ï¼ˆ100+èŠ‚ç‚¹ï¼‰æµç•…æ¸²æŸ“
- å¢åŠ ä¼˜ç§€çš„åº“æ¥æå‡å¤–è§‚
- ä¸»é¢˜å˜ä¸ºé»‘è‰²çš„æ—¶å€™ï¼Œä¸€äº›èœå•è¦é€‚é…

#### æ¶‰åŠæŠ€æœ¯
- ReactFlow æ€§èƒ½ä¼˜åŒ–ï¼ˆèŠ‚ç‚¹è™šæ‹ŸåŒ–ï¼‰
- çŠ¶æ€æŒä¹…åŒ–ï¼ˆè®°ä½ç”¨æˆ·åå¥½çš„è§†å›¾æ¨¡å¼ï¼‰
- åŠ¨ç”»åº“é›†æˆ
- å•å…ƒæµ‹è¯• & E2E æµ‹è¯•

#### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
```mermaid
graph TB
    subgraph Optimizations[æ€§èƒ½ä¼˜åŒ–]
        Virtualization[èŠ‚ç‚¹è™šæ‹ŸåŒ–<br/>åªæ¸²æŸ“å¯è§†åŒºåŸŸ]
        LazyContent[å†…å®¹æ‡’åŠ è½½<br/>èŠ‚ç‚¹å†…å®¹æŒ‰éœ€åŠ è½½]
        MemoizedNodes[èŠ‚ç‚¹è®°å¿†åŒ–<br/>React.memoä¼˜åŒ–]
        BatchUpdates[æ‰¹é‡æ›´æ–°<br/>åˆå¹¶çŠ¶æ€å˜æ›´]
    end
```

---

## 5. é£é™©ä¸åº”å¯¹

| é£é™© | å½±å“ | åº”å¯¹ç­–ç•¥ |
|------|------|----------|
| ReactFlow å­¦ä¹ æ›²çº¿ | å¼€å‘å‘¨æœŸå»¶é•¿ | å…ˆåšæœ€å°å¯è¡Œç‰ˆæœ¬ï¼Œé€æ­¥è¿­ä»£ |
| å¤§å‹å¯¹è¯æ€§èƒ½é—®é¢˜ | ç”¨æˆ·ä½“éªŒä¸‹é™ | æ—©æœŸå¼•å…¥è™šæ‹ŸåŒ–ï¼Œè®¾ç½®èŠ‚ç‚¹æ•°é‡é¢„è­¦ |
| æ•°æ®åŒæ­¥å¤æ‚åº¦ | æ•°æ®ä¸ä¸€è‡´ | å•ä¸€æ•°æ®æºåŸåˆ™ï¼Œæ‰€æœ‰æ“ä½œèµ° sessionActions |
| ç§»åŠ¨ç«¯é€‚é… | è§¦æ‘¸äº¤äº’å›°éš¾ | ç§»åŠ¨ç«¯é»˜è®¤ä½¿ç”¨åˆ—è¡¨è§†å›¾ï¼ŒèŠ‚ç‚¹è§†å›¾ä»…æ¡Œé¢ç«¯ |

---

## 6. æˆåŠŸæŒ‡æ ‡

- [ ] è§†å›¾åˆ‡æ¢å“åº”æ—¶é—´ < 200ms
- [ ] 100 èŠ‚ç‚¹ä»¥ä¸‹å¯¹è¯æ ‘æ¸²æŸ“å¸§ç‡ > 30fps
- [ ] æ‰€æœ‰ç°æœ‰åˆ†æ”¯åŠŸèƒ½åœ¨èŠ‚ç‚¹è§†å›¾ä¸­å¯ç”¨
- [ ] ä¸¤ç§è§†å›¾æ•°æ®å®Œå…¨åŒæ­¥ï¼Œæ— ä¸ä¸€è‡´æƒ…å†µ
- [ ] ç”¨æˆ·æ— éœ€å­¦ä¹ å³å¯ç†è§£èŠ‚ç‚¹è§†å›¾çš„å«ä¹‰

---

## é™„å½•ï¼šå‚è€ƒèµ„æ–™

- [ReactFlow å®˜æ–¹æ–‡æ¡£](https://reactflow.dev/)
- [dagre å¸ƒå±€ç®—æ³•](https://github.com/dagrejs/dagre)
- [Git Graph å¯è§†åŒ–å‚è€ƒ](https://github.com/mhutchie/vscode-git-graph)
- [Houdini èŠ‚ç‚¹ç¼–è¾‘å™¨ UI å‚è€ƒ](https://www.sidefx.com/docs/houdini/network/index.html)
