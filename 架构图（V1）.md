# Chatbox é¡¹ç›®æ¶æ„æ–‡æ¡£ V1.2

## ğŸ“‹ ç›®å½•
- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
- [èŠ‚ç‚¹è§†å›¾æ¶æ„](#èŠ‚ç‚¹è§†å›¾æ¶æ„)
- [æ•°æ®æµä¸çŠ¶æ€ç®¡ç†](#æ•°æ®æµä¸çŠ¶æ€ç®¡ç†)
- [å¤šå¹³å°æ”¯æŒ](#å¤šå¹³å°æ”¯æŒ)
- [æ„å»ºä¸éƒ¨ç½²](#æ„å»ºä¸éƒ¨ç½²)
- [æ‰©å±•å¼€å‘æŒ‡å—](#æ‰©å±•å¼€å‘æŒ‡å—)

---

## é¡¹ç›®æ¦‚è¿°

**Chatbox Community Edition** æ˜¯ä¸€ä¸ªå¼€æºçš„æ¡Œé¢AIå®¢æˆ·ç«¯ï¼Œæ”¯æŒå¤šç§å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰æä¾›å•†ã€‚é¡¹ç›®é‡‡ç”¨ GPLv3 è®¸å¯è¯ï¼Œæ”¯æŒ Windowsã€macOSã€Linux æ¡Œé¢å¹³å°ä»¥åŠ iOSã€Android ç§»åŠ¨å¹³å°ã€‚

### æ ¸å¿ƒç‰¹æ€§
- ğŸ–¥ï¸ **å¤šå¹³å°æ”¯æŒ**: æ¡Œé¢ç«¯ï¼ˆElectronï¼‰ã€Webç«¯ã€ç§»åŠ¨ç«¯ï¼ˆCapacitorï¼‰
- ğŸ¤– **å¤šæ¨¡å‹é›†æˆ**: OpenAIã€Claudeã€Google Geminiã€Azure OpenAIã€Ollama ç­‰
- ğŸ’¾ **æœ¬åœ°æ•°æ®å­˜å‚¨**: æ•°æ®å®Œå…¨å­˜å‚¨åœ¨æœ¬åœ°è®¾å¤‡
- ğŸ¨ **ç°ä»£åŒ–UI**: React + Mantine + Tailwind CSS
- ğŸŒ **å›½é™…åŒ–**: æ”¯æŒ8ç§è¯­è¨€
- ğŸ”Œ **MCPåè®®æ”¯æŒ**: Model Context Protocolé›†æˆ
- ğŸŒ³ **èŠ‚ç‚¹å¼å¯¹è¯è§†å›¾**: å¯è§†åŒ–å¯¹è¯åˆ†æ”¯æ ‘ï¼Œæ”¯æŒ Git é£æ ¼çš„åˆ†æ”¯ç®¡ç†
- ğŸ”„ **è§†å›¾çŠ¶æ€æŒä¹…åŒ–**: èŠ‚ç‚¹ä½ç½®ã€è§†å£çŠ¶æ€è‡ªåŠ¨ä¿å­˜ä¸æ¢å¤
- âœ¨ **ä¸°å¯Œçš„èŠ‚ç‚¹äº¤äº’**: æ¶ˆæ¯è¯¦æƒ…æŠ½å±‰ã€æ‚¬æµ®æ“ä½œæ ã€æ–‡æœ¬å¼•ç”¨ã€å°±åœ°åˆ›å»ºèŠ‚ç‚¹

---

## æŠ€æœ¯æ ˆ

### å‰ç«¯æŠ€æœ¯æ ˆ
```json
{
  "æ¡†æ¶": "React 18.2",
  "UIåº“": [
    "Mantine 7.x (ä¸»è¦UIç»„ä»¶åº“)",
    "Material-UI 5.x (éƒ¨åˆ†ç»„ä»¶)",
    "Radix UI (æ— å¤´ç»„ä»¶)"
  ],
  "æ ·å¼": [
    "Tailwind CSS 3.x",
    "Emotion (CSS-in-JS)",
    "PostCSS"
  ],
  "çŠ¶æ€ç®¡ç†": [
    "Jotai (åŸå­åŒ–çŠ¶æ€)",
    "Zustand (å…¨å±€çŠ¶æ€)",
    "TanStack Query (æœåŠ¡ç«¯çŠ¶æ€)"
  ],
  "è·¯ç”±": "TanStack Router 1.x",
  "ç±»å‹æ£€æŸ¥": "TypeScript 5.8",
  "èŠ‚ç‚¹å›¾": "@xyflow/react (ReactFlow)",
  "å¸ƒå±€ç®—æ³•": "dagre"
}
```

### åç«¯æŠ€æœ¯æ ˆï¼ˆElectronä¸»è¿›ç¨‹ï¼‰
```json
{
  "è¿è¡Œæ—¶": "Electron 26.x",
  "å­˜å‚¨": "electron-store",
  "æ—¥å¿—": "electron-log",
  "è‡ªåŠ¨æ›´æ–°": "electron-updater",
  "æ•°æ®åº“": "@mastra/libsql (çŸ¥è¯†åº“åŠŸèƒ½)"
}
```

### AI/LLMé›†æˆ
```json
{
  "AI SDK": "Vercel AI SDK 5.x",
  "æ¨¡å‹æä¾›å•†": [
    "@ai-sdk/openai",
    "@ai-sdk/anthropic",
    "@ai-sdk/google",
    "@ai-sdk/azure",
    "@ai-sdk/mistral",
    "@ai-sdk/perplexity",
    "@openrouter/ai-sdk-provider"
  ],
  "MCPåè®®": "@modelcontextprotocol/sdk"
}
```

### æ„å»ºå·¥å…·
```json
{
  "æ‰“åŒ…": "Webpack 5.x",
  "ä»£ç è½¬æ¢": "Babel + TypeScript",
  "æ¡Œé¢æ‰“åŒ…": "electron-builder",
  "ç§»åŠ¨ç«¯": "Capacitor 6.x",
  "ä»£ç è´¨é‡": "Biome (æ›¿ä»£ESLint+Prettier)",
  "æµ‹è¯•": "Vitest"
}
```

---

## é¡¹ç›®ç»“æ„

```
chatbox_gitLine/
â”œâ”€â”€ .erb/                           # Electron React Boilerplate é…ç½®
â”‚   â”œâ”€â”€ configs/                    # Webpacké…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ webpack.config.main.prod.ts
â”‚   â”‚   â”œâ”€â”€ webpack.config.renderer.dev.ts
â”‚   â”‚   â””â”€â”€ webpack.config.renderer.prod.ts
â”‚   â””â”€â”€ scripts/                    # æ„å»ºè„šæœ¬
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main/                       # Electronä¸»è¿›ç¨‹ä»£ç 
â”‚   â”‚   â”œâ”€â”€ main.ts                 # ä¸»è¿›ç¨‹å…¥å£
â”‚   â”‚   â”œâ”€â”€ preload.ts              # é¢„åŠ è½½è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ menu.ts                 # åº”ç”¨èœå•
â”‚   â”‚   â”œâ”€â”€ store-node.ts           # æ•°æ®æŒä¹…åŒ–ï¼ˆelectron-storeï¼‰
â”‚   â”‚   â”œâ”€â”€ app-updater.ts          # è‡ªåŠ¨æ›´æ–°
â”‚   â”‚   â”œâ”€â”€ window_state.ts         # çª—å£çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ adapters/               # ä¸»è¿›ç¨‹é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ knowledge-base/         # çŸ¥è¯†åº“åŠŸèƒ½
â”‚   â”‚   â””â”€â”€ mcp/                    # MCPåè®®å®ç°
â”‚   â”‚
â”‚   â”œâ”€â”€ renderer/                   # æ¸²æŸ“è¿›ç¨‹ä»£ç ï¼ˆå‰ç«¯ï¼‰
â”‚   â”‚   â”œâ”€â”€ index.tsx               # æ¸²æŸ“è¿›ç¨‹å…¥å£
â”‚   â”‚   â”œâ”€â”€ router.tsx              # è·¯ç”±é…ç½®
â”‚   â”‚   â”œâ”€â”€ Sidebar.tsx             # ä¾§è¾¹æ ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ routes/                 # è·¯ç”±é¡µé¢
â”‚   â”‚   â”‚   â”œâ”€â”€ __root.tsx          # æ ¹è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx           # ä¸»èŠå¤©é¡µé¢
â”‚   â”‚   â”‚   â”œâ”€â”€ session/            # ä¼šè¯ç›¸å…³è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ settings/           # è®¾ç½®ç›¸å…³è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ copilots.tsx        # CopilotåŠŸèƒ½
â”‚   â”‚   â”‚   â””â”€â”€ about.tsx           # å…³äºé¡µé¢
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ components/             # å¯å¤ç”¨ç»„ä»¶ï¼ˆ50+ç»„ä»¶ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ Message.tsx         # æ¶ˆæ¯ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ MessageList.tsx     # æ¶ˆæ¯åˆ—è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ Markdown.tsx        # Markdownæ¸²æŸ“
â”‚   â”‚   â”‚   â”œâ”€â”€ ModelList.tsx       # æ¨¡å‹é€‰æ‹©
â”‚   â”‚   â”‚   â”œâ”€â”€ SessionItem.tsx     # ä¼šè¯é¡¹
â”‚   â”‚   â”‚   â”œâ”€â”€ Artifact.tsx        # å·¥ä»¶å±•ç¤º
â”‚   â”‚   â”‚   â”œâ”€â”€ conversation-tree/  # èŠ‚ç‚¹è§†å›¾ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts                    # ç»„ä»¶å¯¼å‡º
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ConversationTreeView.tsx    # ä¸»è§†å›¾ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ViewModeSwitch.tsx          # è§†å›¾åˆ‡æ¢æŒ‰é’®
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MessageDetailDrawer.tsx     # æ¶ˆæ¯è¯¦æƒ…æŠ½å±‰
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ NodeActionBar.tsx           # èŠ‚ç‚¹æ‚¬æµ®æ“ä½œæ 
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ NodeCreatePopover.tsx       # èŠ‚ç‚¹åˆ›å»ºé¢æ¿
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TextSelectionQuote.tsx      # æ–‡æœ¬é€‰ä¸­å¼•ç”¨
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TargetNodeSelector.tsx      # ç›®æ ‡èŠ‚ç‚¹é€‰æ‹©å™¨
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ nodes/                      # è‡ªå®šä¹‰èŠ‚ç‚¹ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SystemNode.tsx          # ç³»ç»Ÿæç¤ºèŠ‚ç‚¹
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ UserNode.tsx            # ç”¨æˆ·æ¶ˆæ¯èŠ‚ç‚¹
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ AssistantNode.tsx       # AIå›å¤èŠ‚ç‚¹
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ edges/                      # è‡ªå®šä¹‰è¾¹ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ActivePathEdge.tsx      # æ´»è·ƒè·¯å¾„è¾¹
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BranchEdge.tsx          # åˆ†æ”¯è¾¹
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ DefaultEdge.tsx         # é»˜è®¤è¾¹
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ utils/                      # å·¥å…·å‡½æ•°
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ branchColors.ts         # åˆ†æ”¯é¢œè‰²ç³»ç»Ÿ
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ stores/                 # çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ chatStore.ts        # èŠå¤©çŠ¶æ€ï¼ˆZustandï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ settingsStore.ts    # è®¾ç½®çŠ¶æ€
â”‚   â”‚   â”‚   â”œâ”€â”€ uiStore.ts          # UIçŠ¶æ€
â”‚   â”‚   â”‚   â”œâ”€â”€ sessionActions.ts   # ä¼šè¯æ“ä½œ
â”‚   â”‚   â”‚   â”œâ”€â”€ viewModeStore.ts    # è§†å›¾æ¨¡å¼çŠ¶æ€ï¼ˆå«è§†å£æŒä¹…åŒ–ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ migration.ts        # æ•°æ®è¿ç§»
â”‚   â”‚   â”‚   â””â”€â”€ atoms/              # JotaiåŸå­çŠ¶æ€
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ lib/                    # å·¥å…·åº“
â”‚   â”‚   â”‚   â”œâ”€â”€ conversation-tree-adapter.ts  # Session â†” Tree è½¬æ¢
â”‚   â”‚   â”‚   â”œâ”€â”€ tree-layout.ts                # dagre å¸ƒå±€ç®—æ³•
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ hooks/                  # è‡ªå®šä¹‰Hooks
â”‚   â”‚   â”œâ”€â”€ modals/                 # æ¨¡æ€å¯¹è¯æ¡†
â”‚   â”‚   â”œâ”€â”€ pages/                  # é¡µé¢ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ i18n/                   # å›½é™…åŒ–
â”‚   â”‚   â”œâ”€â”€ platform/               # å¹³å°é€‚é…
â”‚   â”‚   â”œâ”€â”€ storage/                # æµè§ˆå™¨å­˜å‚¨
â”‚   â”‚   â”œâ”€â”€ adapters/               # æ¸²æŸ“è¿›ç¨‹é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ native/                 # åŸç”ŸåŠŸèƒ½é›†æˆ
â”‚   â”‚   â”œâ”€â”€ setup/                  # åˆå§‹åŒ–è®¾ç½®
â”‚   â”‚   â””â”€â”€ static/                 # é™æ€èµ„æº
â”‚   â”‚
â”‚   â””â”€â”€ shared/                     # ä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹å…±äº«ä»£ç 
â”‚       â”œâ”€â”€ types.ts                # ç±»å‹å®šä¹‰
â”‚       â”œâ”€â”€ defaults.ts             # é»˜è®¤é…ç½®
â”‚       â”œâ”€â”€ constants.ts            # å¸¸é‡
â”‚       â”œâ”€â”€ models/                 # æ•°æ®æ¨¡å‹
â”‚       â”œâ”€â”€ request/                # è¯·æ±‚å°è£…
â”‚       â””â”€â”€ utils/                  # é€šç”¨å·¥å…·
â”‚
â”œâ”€â”€ assets/                         # åº”ç”¨èµ„æº
â”œâ”€â”€ resources/                      # æ‰“åŒ…èµ„æº
â”œâ”€â”€ icons/                          # å›¾æ ‡
â”œâ”€â”€ release/                        # å‘å¸ƒè¾“å‡º
â”œâ”€â”€ docs/                           # æ–‡æ¡£
â”œâ”€â”€ team-sharing/                   # å›¢é˜Ÿå…±äº«åŠŸèƒ½
â”œâ”€â”€ test/                           # æµ‹è¯•æ–‡ä»¶
â”‚
â”œâ”€â”€ package.json                    # é¡¹ç›®é…ç½®
â”œâ”€â”€ tsconfig.json                   # TypeScripté…ç½®
â”œâ”€â”€ electron-builder.yml            # Electronæ‰“åŒ…é…ç½®
â”œâ”€â”€ tailwind.config.js              # Tailwindé…ç½®
â”œâ”€â”€ biome.json                      # Biomeé…ç½®
â””â”€â”€ vitest.config.ts                # æµ‹è¯•é…ç½®
```

---

## æ ¸å¿ƒæ¶æ„

### 1. Electron æ¶æ„ï¼ˆåŒè¿›ç¨‹æ¨¡å‹ï¼‰

```mermaid
graph TB
    subgraph Main[ä¸»è¿›ç¨‹ Main Process]
        A1[main.ts]
        A2[menu.ts]
        A3[store-node.ts]
        A4[app-updater]
        A5[windowç®¡ç†]
    end
    
    subgraph Renderer[æ¸²æŸ“è¿›ç¨‹ Renderer Process]
        B1[React App]
        B2[UIç»„ä»¶]
        B3[çŠ¶æ€ç®¡ç†]
        B4[è·¯ç”±]
    end
    
    C[Preload Script å®‰å…¨æ¡¥æ¥]
    D[Web APIs localStorage]
    
    Main <--> |IPCé€šä¿¡| Renderer
    Main --> C
    Renderer --> D
```

#### ä¸»è¿›ç¨‹èŒè´£ (`src/main/`)
- **çª—å£ç®¡ç†**: åˆ›å»ºã€é”€æ¯ã€çŠ¶æ€ä¿å­˜
- **ç³»ç»Ÿé›†æˆ**: èœå•ã€æ‰˜ç›˜ã€å¿«æ·é”®ã€è‡ªåŠ¨å¯åŠ¨
- **æ•°æ®æŒä¹…åŒ–**: electron-store ç®¡ç†é…ç½®å’Œæ•°æ®
- **è‡ªåŠ¨æ›´æ–°**: electron-updater å¤„ç†åº”ç”¨æ›´æ–°
- **æ–‡ä»¶å¤„ç†**: æ–‡ä»¶è§£æï¼ˆPDFã€Officeã€EPUBç­‰ï¼‰
- **æ·±åº¦é“¾æ¥**: å¤„ç† `chatbox://` åè®®
- **çŸ¥è¯†åº“**: æœ¬åœ°æ•°æ®åº“ç®¡ç†
- **MCPæœåŠ¡**: Model Context Protocol å®ç°

#### æ¸²æŸ“è¿›ç¨‹èŒè´£ (`src/renderer/`)
- **UIæ¸²æŸ“**: Reactç»„ä»¶æ ‘
- **ç”¨æˆ·äº¤äº’**: äº‹ä»¶å¤„ç†ã€è¡¨å•ç®¡ç†
- **çŠ¶æ€ç®¡ç†**: Jotai + Zustand
- **è·¯ç”±å¯¼èˆª**: TanStack Router
- **APIè°ƒç”¨**: ä¸LLMæä¾›å•†é€šä¿¡

#### Preloadè„šæœ¬ (`src/main/preload.ts`)
- å®‰å…¨åœ°æš´éœ²ä¸»è¿›ç¨‹APIåˆ°æ¸²æŸ“è¿›ç¨‹
- æä¾›ç±»å‹å®‰å…¨çš„IPCé€šä¿¡

### 2. å‰ç«¯æ¶æ„

```mermaid
graph TD
    A[TanStack Router è·¯ç”±å±‚]
    
    subgraph Pages[é¡µé¢ç»„ä»¶ routes]
        B1[index.tsx ä¸»èŠå¤©]
        B2[session ä¼šè¯è¯¦æƒ…]
        B3[settings è®¾ç½®]
    end
    
    subgraph Components[ä¸šåŠ¡ç»„ä»¶ components]
        C1[Message MessageList]
        C2[Sidebar SessionList]
        C3[Markdown Mermaid]
        C4[ConversationTree èŠ‚ç‚¹è§†å›¾]
    end
    
    subgraph Stores[çŠ¶æ€ç®¡ç† stores]
        D1[chatStore Zustand]
        D2[settingsStore Zustand]
        D3[uiStore Zustand]
        D4[viewModeStore Zustand]
        D5[Jotai Atoms]
        D6[TanStack Query]
    end
    
    A --> Pages
    Pages --> Components
    Components --> Stores
```

### 3. æ•°æ®æ¨¡å‹

#### æ ¸å¿ƒå®ä½“ (`src/shared/types/`)

**Sessionï¼ˆä¼šè¯ï¼‰**
```typescript
interface Session {
  id: string
  name: string
  model: string
  modelProvider: ModelProviderType
  sessionSettings: SessionSettings
  threads: SessionThread[]
  messages: Message[]
  messageForksHash: Record<string, string[]>  // åˆ†æ”¯æ˜ å°„
  createdAt: number
  updatedAt: number
}
```

**Messageï¼ˆæ¶ˆæ¯ï¼‰**
```typescript
interface Message {
  id: string
  role: 'system' | 'user' | 'assistant' | 'tool'
  contentParts: MessageContentParts  // æ”¯æŒå¤šæ¨¡æ€å†…å®¹
  generating?: boolean
  cancel?: () => void
  usage?: LanguageModelUsage
}
```

**Settingsï¼ˆè®¾ç½®ï¼‰**
```typescript
interface Settings {
  language: string
  theme: Theme
  fontSize: number
  // æ¨¡å‹é…ç½®
  // UIé…ç½®
  // å¿«æ·é”®é…ç½®
  // ...
}
```

### 4. AIæ¨¡å‹é›†æˆæ¶æ„

```mermaid
graph TD
    A[Vercel AI SDK ç»Ÿä¸€æ¥å£]
    
    subgraph Providers[æ¨¡å‹æä¾›å•†é€‚é…å™¨]
        B1[OpenAI Provider]
        B2[Anthropic Provider]
        B3[Google Provider]
        B4[Azure Provider]
        B5[Mistral Provider]
        B6[Perplexity Provider]
        B7[Ollama Provider]
        B8[OpenRouter Provider]
    end
    
    A --> B1
    A --> B2
    A --> B3
    A --> B4
    A --> B5
    A --> B6
    A --> B7
    A --> B8
```

**ç»Ÿä¸€æ¨¡å‹æ¥å£**:
- æ‰€æœ‰æ¨¡å‹æä¾›å•†é€šè¿‡ Vercel AI SDK ç»Ÿä¸€å¤„ç†
- æ”¯æŒæµå¼å’Œéæµå¼å“åº”
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- Tokenè®¡æ•°å’Œä½¿ç”¨ç»Ÿè®¡

---

## èŠ‚ç‚¹è§†å›¾æ¶æ„

### 1. æ•´ä½“æ¶æ„

```mermaid
graph TB
    subgraph DataLayer[æ•°æ®å±‚ - ä¿æŒä¸å˜]
        Session[Session ä¼šè¯æ•°æ®]
        Messages[messages: Message]
        Threads[threads: SessionThread]
        Forks[messageForksHash: Record]
    end

    subgraph StoreLayer[çŠ¶æ€ç®¡ç†å±‚]
        ChatStore[chatStore]
        SessionActions[sessionActions]
        ViewModeStore[viewModeStore<br/>è§†å›¾çŠ¶æ€ç®¡ç†]
    end

    subgraph AdapterLayer[é€‚é…å±‚]
        TreeAdapter[conversation-tree-adapter<br/>Session â†” æ ‘å½¢ç»“æ„è½¬æ¢]
        TreeLayout[tree-layout<br/>dagre å¸ƒå±€ç®—æ³•]
    end

    subgraph ViewLayer[è§†å›¾å±‚]
        ViewSwitch[ViewModeSwitch<br/>è§†å›¾åˆ‡æ¢æŒ‰é’®]
        
        subgraph ListView[åˆ—è¡¨è§†å›¾]
            MessageList[MessageList]
            Message[Message]
        end
        
        subgraph TreeView[èŠ‚ç‚¹è§†å›¾]
            ConversationTree[ConversationTreeView]
            TreeNodes[è‡ªå®šä¹‰èŠ‚ç‚¹ç»„ä»¶]
            TreeEdges[è‡ªå®šä¹‰è¿çº¿ç»„ä»¶]
            TreeControls[æ§åˆ¶é¢æ¿]
        end
    end

    Session --> Messages
    Session --> Threads
    Session --> Forks

    ChatStore --> Session
    SessionActions --> ChatStore
    ViewModeStore --> ViewSwitch

    TreeAdapter --> Session
    TreeAdapter --> TreeLayout
    TreeLayout --> ConversationTree

    ViewSwitch --> ListView
    ViewSwitch --> TreeView

    ChatStore --> MessageList
    ChatStore --> ConversationTree
```

### 2. æ ¸å¿ƒæ•°æ®ç»“æ„

#### ViewMode çŠ¶æ€
```typescript
type ViewMode = 'list' | 'tree'

/** èŠ‚ç‚¹ä½ç½®ç±»å‹ */
type NodePositions = Record<string, { x: number; y: number }>

/** æŒ‰ä¼šè¯IDå­˜å‚¨çš„èŠ‚ç‚¹ä½ç½® */
type SessionNodePositions = Record<string, NodePositions>

/** è§†å£çŠ¶æ€ç±»å‹ */
type ViewportState = { x: number; y: number; zoom: number }

/** æŒ‰ä¼šè¯IDå­˜å‚¨çš„è§†å£çŠ¶æ€ */
type SessionViewports = Record<string, ViewportState>

interface ViewModeState {
  viewMode: ViewMode                    // å½“å‰è§†å›¾æ¨¡å¼
  selectedNodeId: string | null         // é€‰ä¸­çš„èŠ‚ç‚¹ID
  treeZoom: number                      // ç¼©æ”¾çº§åˆ«ï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰
  treePosition: { x: number; y: number } // ç”»å¸ƒä½ç½®ï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰
  nodePositions: SessionNodePositions   // æŒ‰ä¼šè¯å­˜å‚¨çš„èŠ‚ç‚¹ä½ç½®
  sessionViewports: SessionViewports    // æŒ‰ä¼šè¯å­˜å‚¨çš„è§†å£çŠ¶æ€
}
```

#### æ ‘èŠ‚ç‚¹æ•°æ®
```typescript
interface TreeNodeData {
  message: Message        // åŸå§‹æ¶ˆæ¯
  type: 'system' | 'user' | 'assistant'
  isActivePath: boolean   // æ˜¯å¦åœ¨æ´»è·ƒè·¯å¾„ä¸Š
  branchIndex: number     // åˆ†æ”¯ç´¢å¼•ï¼ˆ0å¼€å§‹ï¼‰
  branchCount: number     // åŒçº§åˆ†æ”¯æ€»æ•°
  hasChildren: boolean    // æ˜¯å¦æœ‰å­èŠ‚ç‚¹
  childrenCount: number   // å­èŠ‚ç‚¹æ•°é‡
  depth: number           // æ·±åº¦å±‚çº§
}
```

#### å¯¹è¯æ ‘ç»“æ„
```typescript
interface ConversationTree {
  nodes: ConversationNode[]
  edges: ConversationEdge[]
  rootId: string | null        // æ ¹èŠ‚ç‚¹ID
  activeLeafId: string | null  // æ´»è·ƒè·¯å¾„å¶å­èŠ‚ç‚¹ID
  activePathIds: Set<string>   // æ´»è·ƒè·¯å¾„èŠ‚ç‚¹IDé›†åˆ
}
```

### 3. æ•°æ®è½¬æ¢æµç¨‹

```mermaid
flowchart LR
    A[Session<br/>åŸå§‹æ•°æ®] --> B[sessionToConversationTree<br/>æ„å»ºæ ‘ç»“æ„]
    B --> C[buildActivePathIds<br/>è®¡ç®—æ´»è·ƒè·¯å¾„]
    C --> D[processForks<br/>å¤„ç†åˆ†æ”¯]
    D --> E[applyTreeLayout<br/>dagreå¸ƒå±€]
    E --> F[ConversationTree<br/>å¸¦ä½ç½®ä¿¡æ¯]
    F --> G[ReactFlow<br/>æ¸²æŸ“]
```

### 4. èŠ‚ç‚¹ç»„ä»¶è®¾è®¡

| èŠ‚ç‚¹ç±»å‹ | ç»„ä»¶ | é¢œè‰²ä¸»é¢˜ | ç‰¹æ®ŠåŠŸèƒ½ |
|---------|------|---------|---------|
| SystemNode | `SystemNode.tsx` | ç°è‰²è™šçº¿è¾¹æ¡† | æ˜¾ç¤ºç³»ç»Ÿæç¤ºé¢„è§ˆ |
| UserNode | `UserNode.tsx` | è“è‰² | é™„ä»¶æ•°é‡ã€åˆ†æ”¯æŒ‡ç¤ºå™¨ |
| AssistantNode | `AssistantNode.tsx` | ç»¿è‰² | æ¨¡å‹åã€tokenç”¨é‡ã€ç”ŸæˆçŠ¶æ€ã€åˆ†æ”¯æŒ‡ç¤ºå™¨ |

**å…±åŒç‰¹æ€§**ï¼š
- æ´»è·ƒè·¯å¾„èŠ‚ç‚¹æœ‰ `ring` é«˜äº®æ•ˆæœ
- éæ´»è·ƒè·¯å¾„èŠ‚ç‚¹ `opacity-60` åŠé€æ˜
- åˆ†æ”¯èŠ‚ç‚¹ä½¿ç”¨ 8 è‰²è°ƒè‰²æ¿åŒºåˆ†
- ä½¿ç”¨ `Handle` ç»„ä»¶æä¾›è¿æ¥ç‚¹

### 5. è¾¹ç»„ä»¶è®¾è®¡

| è¾¹ç±»å‹ | ç»„ä»¶ | æ ·å¼ | ç”¨é€” |
|-------|------|------|------|
| ActivePathEdge | `ActivePathEdge.tsx` | ç»¿è‰²å®çº¿ + å‘å…‰ + æµåŠ¨åŠ¨ç”» | å½“å‰æ´»è·ƒå¯¹è¯è·¯å¾„ |
| BranchEdge | `BranchEdge.tsx` | å½©è‰²è™šçº¿ (æ ¹æ® branchIndex) | éæ´»è·ƒåˆ†æ”¯ |
| DefaultEdge | `DefaultEdge.tsx` | ç°è‰²å®çº¿ | æ™®é€šè¿çº¿ |

### 6. å¸ƒå±€é…ç½®

```typescript
const DEFAULT_OPTIONS = {
  nodeWidth: 280,
  nodeHeight: 120,
  horizontalSpacing: 50,
  verticalSpacing: 80,
  direction: 'TB',  // ä»ä¸Šåˆ°ä¸‹
}
```

### 7. çŠ¶æ€æŒä¹…åŒ–æœºåˆ¶

èŠ‚ç‚¹è§†å›¾å®ç°äº†å®Œæ•´çš„çŠ¶æ€æŒä¹…åŒ–ï¼Œç¡®ä¿ç”¨æˆ·åœ¨åˆ‡æ¢è§†å›¾æˆ–åˆ·æ–°é¡µé¢åèƒ½æ¢å¤ä¹‹å‰çš„çŠ¶æ€ï¼š

#### æŒä¹…åŒ–å†…å®¹
| çŠ¶æ€ç±»å‹ | å­˜å‚¨ä½ç½® | è¯´æ˜ |
|---------|---------|------|
| èŠ‚ç‚¹ä½ç½® | `nodePositions[sessionId]` | æ¯ä¸ªèŠ‚ç‚¹çš„ x, y åæ ‡ |
| è§†å£çŠ¶æ€ | `sessionViewports[sessionId]` | ç”»å¸ƒçš„å¹³ç§»å’Œç¼©æ”¾çŠ¶æ€ |
| è§†å›¾æ¨¡å¼ | `viewMode` | åˆ—è¡¨/æ ‘å½¢è§†å›¾åˆ‡æ¢çŠ¶æ€ |

#### æŒä¹…åŒ–æµç¨‹
```mermaid
flowchart LR
    A[ç”¨æˆ·æ“ä½œ] --> B{æ“ä½œç±»å‹}
    B -->|æ‹–æ‹½èŠ‚ç‚¹| C[handleNodeDragStop]
    B -->|å¹³ç§»/ç¼©æ”¾| D[useOnViewportChange.onEnd]
    C --> E[updateNodePosition]
    D --> F[saveSessionViewport]
    E --> G[Zustand persist]
    F --> G
    G --> H[localStorage]
```

#### æ¢å¤æµç¨‹
```mermaid
flowchart LR
    A[ç»„ä»¶æŒ‚è½½] --> B[è¯»å– nodePositionsFromStore]
    B --> C[initialNodes ä½¿ç”¨ä¿å­˜ä½ç½®]
    A --> D[è¯»å– sessionViewport]
    D --> E{æœ‰ä¿å­˜çŠ¶æ€?}
    E -->|æ˜¯| F[setViewport æ¢å¤]
    E -->|å¦| G[fitView è‡ªé€‚åº”]
```

### 8. äº¤äº’ç»„ä»¶æ¶æ„

èŠ‚ç‚¹è§†å›¾æä¾›äº†ä¸°å¯Œçš„äº¤äº’ç»„ä»¶ï¼š

```mermaid
graph TB
    subgraph InteractionComponents[äº¤äº’ç»„ä»¶]
        MDD[MessageDetailDrawer<br/>æ¶ˆæ¯è¯¦æƒ…æŠ½å±‰]
        NAB[NodeActionBar<br/>èŠ‚ç‚¹æ‚¬æµ®æ“ä½œæ ]
        NCP[NodeCreatePopover<br/>èŠ‚ç‚¹åˆ›å»ºé¢æ¿]
        TSQ[TextSelectionQuote<br/>æ–‡æœ¬é€‰ä¸­å¼•ç”¨]
        TNS[TargetNodeSelector<br/>ç›®æ ‡èŠ‚ç‚¹é€‰æ‹©å™¨]
    end
    
    subgraph Triggers[è§¦å‘æ–¹å¼]
        T1[å•å‡»èŠ‚ç‚¹] --> MDD
        T2[é¼ æ ‡æ‚¬æµ®] --> NAB
        T3[ç‚¹å‡» Output Handle] --> NCP
        T4[é€‰ä¸­æ–‡å­—] --> TSQ
        T5[åº•éƒ¨è¾“å…¥æ¡†] --> TNS
    end
```

#### ç»„ä»¶åŠŸèƒ½è¯´æ˜

| ç»„ä»¶ | æ–‡ä»¶ | åŠŸèƒ½ |
|-----|------|------|
| MessageDetailDrawer | `MessageDetailDrawer.tsx` | å³ä¾§æŠ½å±‰æ˜¾ç¤ºå®Œæ•´æ¶ˆæ¯å†…å®¹ï¼Œæ”¯æŒ Markdown æ¸²æŸ“ |
| NodeActionBar | `NodeActionBar.tsx` | æ‚¬æµ®æ“ä½œæ ï¼šç¼–è¾‘ã€å¤åˆ¶ã€å¼•ç”¨ã€åˆ é™¤ã€é‡æ–°ç”Ÿæˆã€åˆ‡æ¢åˆ†æ”¯ |
| NodeCreatePopover | `NodeCreatePopover.tsx` | å°±åœ°åˆ›å»º User/Assistant èŠ‚ç‚¹ï¼Œæ”¯æŒç®€æ˜“è¾“å…¥ |
| TextSelectionQuote | `TextSelectionQuote.tsx` | é€‰ä¸­æ–‡å­—åæ˜¾ç¤ºå¼•ç”¨æŒ‰é’®ï¼Œåˆ›å»ºå¸¦å¼•ç”¨çš„æ–°æ¶ˆæ¯ |
| TargetNodeSelector | `TargetNodeSelector.tsx` | åº•éƒ¨è¾“å…¥æ¡†å¢å¼ºï¼Œå¯æŒ‡å®šæ¶ˆæ¯æ’å…¥ä½ç½® |

### 9. åˆ†æ”¯é¢œè‰²æ–¹æ¡ˆ

8ç§é¢„å®šä¹‰é¢œè‰²å¾ªç¯ä½¿ç”¨ï¼š
- amber, violet, pink, cyan, orange, purple, teal, red

æ¯ç§é¢œè‰²åŒ…å«ï¼š`{ bg, border, text }` ä¸‰ä¸ªå±æ€§

---

## æ•°æ®æµä¸çŠ¶æ€ç®¡ç†

### çŠ¶æ€ç®¡ç†ç­–ç•¥

é¡¹ç›®é‡‡ç”¨**åˆ†å±‚çŠ¶æ€ç®¡ç†**ç­–ç•¥ï¼Œä¸åŒç±»å‹çš„çŠ¶æ€ä½¿ç”¨ä¸åŒçš„å·¥å…·ï¼š

#### 1. Zustand - å…¨å±€åº”ç”¨çŠ¶æ€
```typescript
// src/renderer/stores/chatStore.ts
export const useChatStore = create<ChatStore>((set) => ({
  sessions: [],
  currentSessionId: null,
  // ...
}))

// src/renderer/stores/viewModeStore.ts
export const useViewModeStore = create<ViewModeState>()(
  persist(
    (set, get) => ({
      viewMode: 'list',
      selectedNodeId: null,
      treeZoom: 1,
      treePosition: { x: 0, y: 0 },
      nodePositions: {},
      sessionViewports: {},
      // actions...
    }),
    {
      name: 'view-mode-store',
      version: 3,
      partialize: (state) => ({
        viewMode: state.viewMode,
        nodePositions: state.nodePositions,
        sessionViewports: state.sessionViewports,
      }),
    }
  )
)
```

**ç®¡ç†å†…å®¹**:
- ä¼šè¯åˆ—è¡¨ (sessions)
- å½“å‰ä¼šè¯ (currentSessionId)
- æ¶ˆæ¯æ•°æ®
- è®¾ç½®é…ç½®
- è§†å›¾æ¨¡å¼ (viewMode)
- èŠ‚ç‚¹ä½ç½® (nodePositions)
- è§†å£çŠ¶æ€ (sessionViewports)

#### 2. Jotai - åŸå­åŒ–UIçŠ¶æ€
```typescript
// src/renderer/stores/atoms/
export const messageInputAtom = atom('')
export const isGeneratingAtom = atom(false)
```

**ç®¡ç†å†…å®¹**:
- è¾“å…¥æ¡†çŠ¶æ€
- åŠ è½½çŠ¶æ€
- ä¸´æ—¶UIçŠ¶æ€

#### 3. TanStack Query - æœåŠ¡ç«¯çŠ¶æ€
```typescript
const { data, isLoading } = useQuery({
  queryKey: ['models'],
  queryFn: fetchModels
})
```

**ç®¡ç†å†…å®¹**:
- APIè¯·æ±‚ç¼“å­˜
- è‡ªåŠ¨é‡è¯•
- åå°æ•°æ®åŒæ­¥

### æ•°æ®æŒä¹…åŒ–

#### æ¡Œé¢ç«¯ï¼ˆElectronï¼‰
```
electron-store (ä¸»è¿›ç¨‹)
â”œâ”€ config.json           # åº”ç”¨é…ç½®
â”œâ”€ sessions/             # ä¼šè¯æ•°æ®
â”œâ”€ settings.json         # ç”¨æˆ·è®¾ç½®
â””â”€ blob/                 # äºŒè¿›åˆ¶æ•°æ®ï¼ˆå›¾ç‰‡ç­‰ï¼‰
```

#### Webç«¯/ç§»åŠ¨ç«¯
```
IndexedDB (localforage)
â”œâ”€ sessions              # ä¼šè¯å­˜å‚¨
â”œâ”€ settings              # è®¾ç½®å­˜å‚¨
â””â”€ files                 # æ–‡ä»¶å­˜å‚¨
```

### æ¶ˆæ¯æµå¤„ç†

```mermaid
flowchart TD
    A[ç”¨æˆ·è¾“å…¥]
    B[sessionActions.sendMessage å¤„ç†æ¶ˆæ¯]
    C[AI SDK è°ƒç”¨ streamText]
    D[æµå¼å“åº”å¤„ç† onChunk]
    E[æ›´æ–°ChatStore ä¿å­˜æ¶ˆæ¯]
    
    A --> B
    B --> C
    C --> D
    D --> E
```

### è§†å›¾åˆ‡æ¢æ•°æ®æµ

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant View as è§†å›¾å±‚
    participant Adapter as é€‚é…å±‚
    participant Store as çŠ¶æ€ç®¡ç†
    participant Data as Sessionæ•°æ®

    rect rgb(200, 230, 200)
        Note over User,Data: åˆ—è¡¨è§†å›¾æ“ä½œæµç¨‹
        User->>View: å‘é€æ¶ˆæ¯
        View->>Store: insertMessage()
        Store->>Data: æ›´æ–° messages[]
        Data-->>View: è§¦å‘é‡æ¸²æŸ“
    end

    rect rgb(200, 200, 230)
        Note over User,Data: èŠ‚ç‚¹è§†å›¾æ“ä½œæµç¨‹
        User->>View: ä»èŠ‚ç‚¹å‘é€æ¶ˆæ¯
        View->>Adapter: å®šä½å½“å‰èŠ‚ç‚¹è·¯å¾„
        Adapter->>Store: insertMessage() / createNewFork()
        Store->>Data: æ›´æ–° messages[] / messageForksHash
        Data->>Adapter: é‡æ–°æ„å»ºæ ‘ç»“æ„
        Adapter-->>View: æ›´æ–°èŠ‚ç‚¹å’Œè¿çº¿
    end
```

### èŠ‚ç‚¹ä½ç½®è®¡ç®—æµç¨‹

æ–°èŠ‚ç‚¹åˆ›å»ºæ—¶çš„ä½ç½®è®¡ç®—ï¼š

```mermaid
flowchart TD
    A[ç”¨æˆ·ç‚¹å‡» Output Handle] --> B[è·å–è§¦å‘èŠ‚ç‚¹ä½ç½®]
    B --> C[calculateNewNodePosition]
    C --> D[newY = triggerY + NODE_HEIGHT + VERTICAL_SPACING]
    D --> E[newX = triggerX]
    E --> F[presaveNewNodePosition]
    F --> G[åˆ›å»ºæ¶ˆæ¯]
    G --> H[applyTreeLayout ä½¿ç”¨ä¿å­˜çš„ä½ç½®]
    H --> I[æ–°èŠ‚ç‚¹å‡ºç°åœ¨è§¦å‘èŠ‚ç‚¹æ­£ä¸‹æ–¹]
```

---

## å¤šå¹³å°æ”¯æŒ

### å¹³å°æŠ½è±¡å±‚ (`src/renderer/platform/`)

é¡¹ç›®é€šè¿‡å¹³å°æŠ½è±¡å±‚å®ç°"ä¸€æ¬¡ç¼–å†™ï¼Œå¤šå¤„è¿è¡Œ"ï¼š

```typescript
// platform/index.ts
const platform = {
  type: 'electron' | 'web' | 'mobile',
  isMac: boolean,
  isWindows: boolean,
  // å¹³å°ç‰¹å®šAPI
}
```

### æ„å»ºç›®æ ‡

#### 1. æ¡Œé¢ç«¯ï¼ˆElectronï¼‰
```bash
npm run dev              # å¼€å‘æ¨¡å¼
npm run build            # æ„å»º
npm run package          # æ‰“åŒ…å½“å‰å¹³å°
npm run package:all      # æ‰“åŒ…æ‰€æœ‰å¹³å°
```

**æ‰“åŒ…è¾“å‡º**:
- Windows: `.exe` (NSISå®‰è£…åŒ…)
- macOS: `.dmg` (Intel + Apple Silicon)
- Linux: `.AppImage`, `.deb`

#### 2. Webç«¯
```bash
npm run dev:web          # Webå¼€å‘æ¨¡å¼
npm run build:web        # Webæ„å»º
npm run serve:web        # é¢„è§ˆWebç‰ˆæœ¬
```

**ç‰¹ç‚¹**:
- çº¯å‰ç«¯åº”ç”¨
- ä½¿ç”¨æµè§ˆå™¨å­˜å‚¨API
- å—æµè§ˆå™¨å®‰å…¨é™åˆ¶

#### 3. ç§»åŠ¨ç«¯ï¼ˆCapacitorï¼‰
```bash
npm run mobile:sync:ios      # åŒæ­¥iOS
npm run mobile:sync:android  # åŒæ­¥Android
npm run mobile:ios           # æ‰“å¼€iOSé¡¹ç›®
npm run mobile:android       # æ‰“å¼€Androidé¡¹ç›®
```

**ç‰¹ç‚¹**:
- ä½¿ç”¨Capacitoræ¡¥æ¥åŸç”ŸåŠŸèƒ½
- åŸç”ŸUIå¤–å£³ + Webå†…å®¹
- æ”¯æŒåŸç”Ÿæ’ä»¶

### å¹³å°å·®å¼‚å¤„ç†

```typescript
// æ¡ä»¶ç¼–è¯‘
if (platform.type === 'electron') {
  // ä½¿ç”¨Electron API
  await window.electron.openFile()
} else if (platform.type === 'mobile') {
  // ä½¿ç”¨Capacitor API
  await Filesystem.readFile(...)
} else {
  // ä½¿ç”¨Web API
  const file = await input.files[0]
}
```

### èŠ‚ç‚¹è§†å›¾å¹³å°é€‚é…

- **æ¡Œé¢ç«¯**ï¼šå®Œæ•´èŠ‚ç‚¹è§†å›¾åŠŸèƒ½
- **Webç«¯**ï¼šå®Œæ•´èŠ‚ç‚¹è§†å›¾åŠŸèƒ½
- **ç§»åŠ¨ç«¯**ï¼šé»˜è®¤ä½¿ç”¨åˆ—è¡¨è§†å›¾ï¼ˆè§¦æ‘¸äº¤äº’ä¼˜åŒ–ï¼‰

---

## æ„å»ºä¸éƒ¨ç½²

### å¼€å‘ç¯å¢ƒ

```bash
# 1. å®‰è£…ä¾èµ–
npm install

# 2. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev          # Electronå¼€å‘æ¨¡å¼
npm run dev:web      # Webå¼€å‘æ¨¡å¼

# 3. è¿è¡Œæµ‹è¯•
npm run test         # è¿è¡Œæµ‹è¯•
npm run test:watch   # ç›‘å¬æ¨¡å¼
npm run test:ui      # UIæµ‹è¯•ç•Œé¢
```

### æ„å»ºé…ç½®

#### Webpacké…ç½®
- `.erb/configs/webpack.config.main.prod.ts` - ä¸»è¿›ç¨‹ç”Ÿäº§æ„å»º
- `.erb/configs/webpack.config.renderer.dev.ts` - æ¸²æŸ“è¿›ç¨‹å¼€å‘
- `.erb/configs/webpack.config.renderer.prod.ts` - æ¸²æŸ“è¿›ç¨‹ç”Ÿäº§

#### Electron Builderé…ç½®
- `electron-builder.yml` - æ‰“åŒ…é…ç½®
- æ”¯æŒä»£ç ç­¾åã€å…¬è¯ã€è‡ªåŠ¨æ›´æ–°

### å‘å¸ƒæµç¨‹

```bash
# 1. æ„å»ºæ‰€æœ‰å¹³å°
npm run package:all

# 2. å‘å¸ƒåˆ°ç‰¹å®šå¹³å°
npm run release:win      # Windows
npm run release:mac      # macOS
npm run release:linux    # Linux
npm run release:web      # Web

# 3. å‘å¸ƒåˆ°åº”ç”¨å•†åº—ï¼ˆéœ€é…ç½®ï¼‰
npm run electron:publish-win
npm run electron:publish-mac
npm run electron:publish-linux
```

### CI/CD
- ä½¿ç”¨GitHub Actions
- è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ
- å¤šå¹³å°å¹¶è¡Œæ„å»º

---

## æ‰©å±•å¼€å‘æŒ‡å—

### 1. æ·»åŠ æ–°çš„AIæ¨¡å‹æä¾›å•†

#### æ­¥éª¤1: å®‰è£…SDK
```bash
npm install @ai-sdk/your-provider
```

#### æ­¥éª¤2: å®šä¹‰æ¨¡å‹ç±»å‹
```typescript
// src/shared/types.ts
export enum ModelProviderEnum {
  // ...
  YourProvider = 'your-provider',
}
```

#### æ­¥éª¤3: åˆ›å»ºé€‚é…å™¨
```typescript
// src/renderer/adapters/your-provider.ts
import { createYourProvider } from '@ai-sdk/your-provider'

export function createProvider(config: Config) {
  return createYourProvider({
    apiKey: config.yourProviderApiKey,
  })
}
```

#### æ­¥éª¤4: é›†æˆåˆ°ä¼šè¯æ“ä½œ
```typescript
// src/renderer/stores/sessionActions.ts
case ModelProviderEnum.YourProvider:
  provider = createYourProvider(config)
  break
```

### 2. æ·»åŠ æ–°çš„èŠ‚ç‚¹ç±»å‹

#### æ­¥éª¤1: åˆ›å»ºèŠ‚ç‚¹ç»„ä»¶
```typescript
// src/renderer/components/conversation-tree/nodes/YourNode.tsx
import { Handle, Position, type NodeProps } from '@xyflow/react'
import type { TreeNodeData } from '@/lib/conversation-tree-adapter'

export function YourNode({ data }: NodeProps<TreeNodeData>) {
  return (
    <div className="your-node-styles">
      <Handle type="target" position={Position.Top} />
      {/* èŠ‚ç‚¹å†…å®¹ */}
      <Handle type="source" position={Position.Bottom} />
    </div>
  )
}
```

#### æ­¥éª¤2: æ³¨å†ŒèŠ‚ç‚¹ç±»å‹
```typescript
// src/renderer/components/conversation-tree/nodes/index.ts
export const nodeTypes = {
  system: SystemNode,
  user: UserNode,
  assistant: AssistantNode,
  your: YourNode,  // æ–°å¢
}
```

### 3. æ·»åŠ æ–°çš„è¾¹ç±»å‹

#### æ­¥éª¤1: åˆ›å»ºè¾¹ç»„ä»¶
```typescript
// src/renderer/components/conversation-tree/edges/YourEdge.tsx
import { BaseEdge, getSmoothStepPath, type EdgeProps } from '@xyflow/react'

export function YourEdge(props: EdgeProps) {
  const [edgePath] = getSmoothStepPath(props)
  return <BaseEdge path={edgePath} style={{ stroke: '#your-color' }} />
}
```

#### æ­¥éª¤2: æ³¨å†Œè¾¹ç±»å‹
```typescript
// src/renderer/components/conversation-tree/edges/index.ts
export const edgeTypes = {
  activePath: ActivePathEdge,
  branch: BranchEdge,
  default: DefaultEdge,
  your: YourEdge,  // æ–°å¢
}
```

### 4. æ·»åŠ æ–°çš„äº¤äº’ç»„ä»¶

èŠ‚ç‚¹è§†å›¾çš„äº¤äº’ç»„ä»¶éµå¾ªç»Ÿä¸€çš„æ¨¡å¼ï¼š

```typescript
// src/renderer/components/conversation-tree/YourInteraction.tsx
import { useViewModeStore } from '@/stores/viewModeStore'

interface YourInteractionProps {
  session: Session
  nodeId: string
  onAction: () => void
}

export function YourInteraction({ session, nodeId, onAction }: YourInteractionProps) {
  const selectedNodeId = useViewModeStore((s) => s.selectedNodeId)
  
  // å®ç°äº¤äº’é€»è¾‘
  return (
    <div className="your-interaction">
      {/* äº¤äº’UI */}
    </div>
  )
}
```

### 5. å›½é™…åŒ–

#### æ·»åŠ ç¿»è¯‘
```typescript
// src/renderer/i18n/locales/en/translation.json
{
  "conversation-tree": {
    "list-view": "List View",
    "tree-view": "Tree View",
    "create-user-node": "New User Message",
    "create-assistant-node": "Generate AI Response",
    "switch-branch": "Switch to this branch"
  }
}

// src/renderer/i18n/locales/zh-Hans/translation.json
{
  "conversation-tree": {
    "list-view": "åˆ—è¡¨è§†å›¾",
    "tree-view": "èŠ‚ç‚¹è§†å›¾",
    "create-user-node": "æ–°å»ºç”¨æˆ·æ¶ˆæ¯",
    "create-assistant-node": "ç”Ÿæˆ AI å›å¤",
    "switch-branch": "åˆ‡æ¢åˆ°æ­¤åˆ†æ”¯"
  }
}
```

#### ä½¿ç”¨ç¿»è¯‘
```typescript
import { useTranslation } from 'react-i18next'

function YourComponent() {
  const { t } = useTranslation()
  return <h1>{t('conversation-tree.tree-view')}</h1>
}
```

### 6. æ ·å¼å¼€å‘

#### Tailwind CSSç±»
```tsx
<div className="flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-100">
  {/* ... */}
</div>
```

#### Mantineç»„ä»¶
```tsx
import { Button, TextInput } from '@mantine/core'

<TextInput
  label="Label"
  placeholder="Placeholder"
/>
<Button variant="filled">Click</Button>
```

### 7. æµ‹è¯•

```typescript
// src/renderer/lib/__tests__/conversation-tree-adapter.test.ts
import { describe, it, expect } from 'vitest'
import { sessionToConversationTree } from '../conversation-tree-adapter'

describe('ConversationTreeAdapter', () => {
  it('should convert session to tree', () => {
    const session = createMockSession()
    const tree = sessionToConversationTree(session)
    expect(tree.nodes.length).toBeGreaterThan(0)
  })
})
```

è¿è¡Œæµ‹è¯•:
```bash
npm run test              # è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm run test:watch        # ç›‘å¬æ¨¡å¼
npm run test:coverage     # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
```

---

## å…³é”®æŠ€æœ¯ç‚¹

### 1. MCPï¼ˆModel Context Protocolï¼‰é›†æˆ
- ä½ç½®: `src/main/mcp/`
- æ”¯æŒä¸MCPæœåŠ¡å™¨é€šä¿¡
- æ‰©å±•LLMèƒ½åŠ›

### 2. çŸ¥è¯†åº“åŠŸèƒ½
- ä½ç½®: `src/main/knowledge-base/`
- ä½¿ç”¨libsqlæ•°æ®åº“
- æ”¯æŒå‘é‡æ£€ç´¢
- RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰

### 3. æ–‡ä»¶è§£æ
- ä½ç½®: `src/main/file-parser.ts`
- æ”¯æŒæ ¼å¼: PDF, DOCX, XLSX, EPUB, TXT, Markdownç­‰
- è‡ªåŠ¨æå–æ–‡æœ¬å†…å®¹

### 4. èŠ‚ç‚¹è§†å›¾
- ä½ç½®: `src/renderer/components/conversation-tree/`
- ä½¿ç”¨ ReactFlow (@xyflow/react) æ¸²æŸ“
- ä½¿ç”¨ dagre è¿›è¡Œè‡ªåŠ¨å¸ƒå±€
- æ”¯æŒåˆ†æ”¯å¯è§†åŒ–å’Œäº¤äº’
- çŠ¶æ€æŒä¹…åŒ–åˆ° localStorageï¼ˆèŠ‚ç‚¹ä½ç½®ã€è§†å£çŠ¶æ€ï¼‰
- ä¸°å¯Œçš„äº¤äº’ç»„ä»¶ï¼ˆè¯¦æƒ…æŠ½å±‰ã€æ“ä½œæ ã€åˆ›å»ºé¢æ¿ç­‰ï¼‰

### 5. è‡ªåŠ¨æ›´æ–°
- ä½¿ç”¨electron-updater
- æ”¯æŒå¢é‡æ›´æ–°
- é…ç½®åœ¨`electron-builder.yml`

### 6. ä»£ç ä¿æŠ¤
- ä½¿ç”¨webpack-obfuscator
- ç”Ÿäº§ç¯å¢ƒä»£ç æ··æ·†
- ä¿æŠ¤æ•æ„Ÿé€»è¾‘

### 7. é”™è¯¯è¿½è¸ª
- é›†æˆSentry
- è‡ªåŠ¨æ•è·å´©æºƒå’Œé”™è¯¯
- å¼€å‘/ç”Ÿäº§ç¯å¢ƒéš”ç¦»

### 8. æ€§èƒ½ç›‘æ§
- Web Vitalsé›†æˆ
- æ€§èƒ½æŒ‡æ ‡æ”¶é›†
- Google Analyticsé›†æˆ

---

## å¼€å‘è§„èŒƒ

### ä»£ç é£æ ¼
- ä½¿ç”¨Biomeè¿›è¡Œä»£ç æ ¼å¼åŒ–å’ŒLint
- é…ç½®æ–‡ä»¶: `biome.json`
- è¿è¡Œ: `npm run lint` / `npm run format`

### Gitå·¥ä½œæµ
- ä½¿ç”¨Huskyç®¡ç†Git Hooks
- Commitå‰è‡ªåŠ¨æ ¼å¼åŒ–: `lint-staged`
- åˆ†æ”¯ä¿æŠ¤

### TypeScript
- ä¸¥æ ¼æ¨¡å¼å¯ç”¨
- è·¯å¾„åˆ«å: `@/*` -> `src/renderer/*`
- æ‰€æœ‰æ–°ä»£ç å¿…é¡»æœ‰ç±»å‹å®šä¹‰

### ç»„ä»¶è§„èŒƒ
- ä½¿ç”¨å‡½æ•°ç»„ä»¶ + Hooks
- Propséœ€è¦TypeScriptæ¥å£å®šä¹‰
- å¤æ‚ç»„ä»¶æ‹†åˆ†ä¸ºå­ç»„ä»¶

---

## å¸¸è§é—®é¢˜

### Q: å¦‚ä½•åˆ‡æ¢åˆ—è¡¨è§†å›¾å’ŒèŠ‚ç‚¹è§†å›¾ï¼Ÿ
**A:** ç‚¹å‡»é¡¶éƒ¨ Header ä¸­çš„è§†å›¾åˆ‡æ¢æŒ‰é’®ï¼ˆåˆ—è¡¨å›¾æ ‡/èŠ‚ç‚¹å›¾æ ‡ï¼‰ã€‚

### Q: èŠ‚ç‚¹è§†å›¾æ”¯æŒå“ªäº›äº¤äº’ï¼Ÿ
**A:** 
- å•å‡»èŠ‚ç‚¹ï¼šæ‰“å¼€å³ä¾§æ¶ˆæ¯è¯¦æƒ…æŠ½å±‰
- åŒå‡»èŠ‚ç‚¹ï¼šç¼–è¾‘æ¶ˆæ¯å†…å®¹
- é¼ æ ‡æ‚¬æµ®ï¼šæ˜¾ç¤ºåº•éƒ¨æ“ä½œæ ï¼ˆç¼–è¾‘ã€å¤åˆ¶ã€å¼•ç”¨ã€åˆ é™¤ã€é‡æ–°ç”Ÿæˆï¼‰
- ç‚¹å‡» Output Handleï¼šå¼¹å‡ºåˆ›å»ºé¢æ¿ï¼Œå¯åˆ›å»º User/Assistant èŠ‚ç‚¹
- é€‰ä¸­æ–‡å­—ï¼šæ˜¾ç¤ºå¼•ç”¨æŒ‰é’®
- æ‹–æ‹½èŠ‚ç‚¹ï¼šè°ƒæ•´èŠ‚ç‚¹ä½ç½®ï¼ˆè‡ªåŠ¨ä¿å­˜ï¼‰
- æ‹–æ‹½ç”»å¸ƒï¼šå¹³ç§»è§†å›¾
- æ»šè½®ï¼šç¼©æ”¾è§†å›¾
- å°åœ°å›¾ï¼šå¿«é€Ÿå¯¼èˆª

### Q: èŠ‚ç‚¹ä½ç½®ä¼šä¿å­˜å—ï¼Ÿ
**A:** æ˜¯çš„ï¼ŒèŠ‚ç‚¹ä½ç½®å’Œè§†å£çŠ¶æ€éƒ½ä¼šè‡ªåŠ¨ä¿å­˜åˆ° localStorageï¼Œåˆ‡æ¢è§†å›¾æˆ–åˆ·æ–°é¡µé¢åä¼šè‡ªåŠ¨æ¢å¤ã€‚

### Q: å¦‚ä½•åœ¨èŠ‚ç‚¹è§†å›¾ä¸­åˆ›å»ºåˆ†æ”¯ï¼Ÿ
**A:** ç‚¹å‡»ä»»æ„èŠ‚ç‚¹åº•éƒ¨çš„ Output Handleï¼ˆåœ†ç‚¹ï¼‰ï¼Œåœ¨å¼¹å‡ºçš„é¢æ¿ä¸­é€‰æ‹©åˆ›å»º User æ¶ˆæ¯æˆ– AI å›å¤ã€‚ä»éå¶å­èŠ‚ç‚¹åˆ›å»ºä¼šè‡ªåŠ¨äº§ç”Ÿæ–°åˆ†æ”¯ã€‚

### Q: å¦‚ä½•åˆ‡æ¢åˆ°å…¶ä»–åˆ†æ”¯ï¼Ÿ
**A:** é¼ æ ‡æ‚¬æµ®åœ¨éå½“å‰åˆ†æ”¯çš„èŠ‚ç‚¹ä¸Šï¼Œç‚¹å‡»æ“ä½œæ ä¸­çš„"åˆ‡æ¢åˆ†æ”¯"æŒ‰é’®ã€‚

### Q: å¦‚ä½•æ·»åŠ æ–°çš„å¿«æ·é”®ï¼Ÿ
**A:** åœ¨`src/main/main.ts`ä¸­æ³¨å†Œå…¨å±€å¿«æ·é”®ï¼Œåœ¨`src/renderer/routes/settings/hotkeys.tsx`ä¸­æ·»åŠ è®¾ç½®é¡¹ã€‚

### Q: å¦‚ä½•è°ƒè¯•ä¸»è¿›ç¨‹ä»£ç ï¼Ÿ
**A:** è¿è¡Œ`npm run dev:debug`ï¼Œç„¶ååœ¨Chromeä¸­æ‰“å¼€`chrome://inspect`ï¼Œè¿æ¥åˆ°`localhost:5858`ã€‚

### Q: æ•°æ®å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ
**A:** 
- Electron: `~/.config/Chatbox` (Linux), `~/Library/Application Support/Chatbox` (Mac), `%APPDATA%\Chatbox` (Windows)
- Web: IndexedDB
- Mobile: åŸç”Ÿå­˜å‚¨

---

## å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£
- [Electronæ–‡æ¡£](https://www.electronjs.org/docs)
- [Reactæ–‡æ¡£](https://react.dev/)
- [TanStack Router](https://tanstack.com/router)
- [Mantine UI](https://mantine.dev/)
- [Vercel AI SDK](https://sdk.vercel.ai/)
- [ReactFlowæ–‡æ¡£](https://reactflow.dev/)
- [dagreå¸ƒå±€ç®—æ³•](https://github.com/dagrejs/dagre)

### é¡¹ç›®æ–‡æ¡£
- [FAQ](./doc/FAQ.md)
- [é”™è¯¯å¤„ç†](./ERROR_HANDLING.md)
- [å›¢é˜Ÿå…±äº«](./team-sharing/README.md)
- [å¼€å‘è®¡åˆ’](./å¼€å‘è®¡åˆ’.md)

---

## æ€»ç»“

Chatbox V1 æ˜¯ä¸€ä¸ªæ¶æ„æ¸…æ™°ã€æ¨¡å—åŒ–è‰¯å¥½çš„ç°ä»£åŒ–AIå®¢æˆ·ç«¯é¡¹ç›®ã€‚å…¶æ ¸å¿ƒç‰¹ç‚¹ï¼š

âœ… **åˆ†å±‚æ¶æ„**: ä¸»è¿›ç¨‹/æ¸²æŸ“è¿›ç¨‹åˆ†ç¦»ï¼ŒèŒè´£æ˜ç¡®
âœ… **å¤šå¹³å°æ”¯æŒ**: ä¸€å¥—ä»£ç ï¼Œå¤šç«¯è¿è¡Œ
âœ… **ç°ä»£æŠ€æœ¯æ ˆ**: React 18 + TypeScript + æœ€æ–°å·¥å…·é“¾
âœ… **å¯æ‰©å±•æ€§å¼º**: æ’ä»¶åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½
âœ… **ä»£ç è´¨é‡é«˜**: ç±»å‹å®‰å…¨ã€æµ‹è¯•è¦†ç›–ã€ä»£ç è§„èŒƒ
âœ… **èŠ‚ç‚¹è§†å›¾**: Git é£æ ¼çš„å¯¹è¯åˆ†æ”¯å¯è§†åŒ–ï¼Œæ”¯æŒçŠ¶æ€æŒä¹…åŒ–å’Œä¸°å¯Œäº¤äº’

é€‚åˆè¿›è¡ŒäºŒæ¬¡å¼€å‘å’ŒåŠŸèƒ½æ‰©å±•ã€‚å»ºè®®ä»å°åŠŸèƒ½å…¥æ‰‹ï¼Œç†Ÿæ‚‰é¡¹ç›®ç»“æ„åå†è¿›è¡Œå¤§å‹æ”¹åŠ¨ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.2  
**æ›´æ–°æ—¥æœŸ**: 2025-12-20  
**é¡¹ç›®ç‰ˆæœ¬**: 0.0.1  
**èŠ‚ç‚¹è§†å›¾åŠŸèƒ½**: é˜¶æ®µä¸€~ä¸‰å·²å®Œæˆï¼ˆåŸºç¡€è®¾æ–½ã€æ ¸å¿ƒè§†å›¾ã€äº¤äº’åŠŸèƒ½ï¼‰
